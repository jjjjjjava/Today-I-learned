[toc]

![image-20250217154643925](./../_pic_/image-20250217154643925.png)

é¢„ä¹ ï¼š

1. ä»€ä¹ˆæ˜¯viewRootï¼Ÿ
2. ä»€ä¹ˆæ˜¯WindowManagerï¼Ÿ
3. ä»€ä¹ˆæ˜¯DecorViewï¼Ÿ
4. ä¸ºä»€ä¹ˆè¯´`ViewRootImpl` è¿æ¥äº† **WindowManager**ï¼ˆå¤–ç•Œçª—å£ç®¡ç†å…¥å£ï¼‰å’Œ **DecorView**ï¼ˆæ•´ä¸ªè§†å›¾æ ‘çš„é¡¶å±‚å®¹å™¨ï¼‰ã€‚
5. DecorViewä¿æŠ¤å†…å®¹æ å’Œæ ‡é¢˜æ ï¼Œè¯·é—®è¿™æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ
6. Viewç»˜åˆ¶çš„å±‚åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ
7. äº§ç”ŸViewå¡é¡¿çš„åŸå› æœ‰å“ªäº›ï¼Ÿ

## 01.Viewå·¥ä½œæµç¨‹

### 1.1 Viewçš„ç®€è¦å·¥ä½œæµç¨‹

- Viewå·¥ä½œæµç¨‹ç®€å•æ¥è¯´å°±æ˜¯ï¼Œå…ˆmeasureæµ‹é‡ï¼Œç”¨äºç¡®å®šViewçš„æµ‹é‡å®½é«˜ï¼Œå† layoutå¸ƒå±€ï¼Œç”¨äºç¡®å®šViewçš„æœ€ç»ˆå®½é«˜å’Œå››ä¸ªé¡¶ç‚¹çš„ä½ç½®ï¼Œæœ€å drawç»˜åˆ¶ï¼Œç”¨äºå°†View ç»˜åˆ¶åˆ°å±å¹•ä¸Šã€‚

### 1.2 Viewçš„æ•´ä½“å·¥ä½œæµç¨‹

- Viewçš„æ•´ä½“å·¥ä½œæµç¨‹ï¼š
  - Viewçš„ç»˜åˆ¶æµç¨‹æ˜¯ä»ViewRootå’ŒperformTraversalså¼€å§‹ã€‚performTraversals()ä¾æ¬¡è°ƒç”¨performMeasure()ã€performLayout()å’ŒperformDraw()ä¸‰ä¸ªæ–¹æ³•ï¼Œå¯¹äºè¿™ä¸‰ä¸ªæ–¹æ³•ï¼Œä»–ä»¬æµç¨‹å¤§è‡´ç›¸åŒï¼Œæˆ‘ä»¬ä¸¾performMeasureä¾‹å­ä»‹ç»ï¼ŒperformMeasure()ä¼šè°ƒç”¨DecorViewçš„measure()ï¼Œè¿›å…¥åˆ°è§†å›¾æ ‘çš„é€»è¾‘å½“ä¸­
  - å¯¹äºViewæ ‘çš„éå†ï¼Œå…¶å®å°±æ˜¯ï¼šDecorView-->ViewGroupï¼ˆ--->ViewGroupï¼‰-->View ï¼ŒæŒ‰ç…§è¿™ä¸ªæµç¨‹ä»ä¸Šå¾€ä¸‹ï¼Œé€å±‚è¿­ä»£ï¼Œä¾æ¬¡measure(æµ‹é‡),layout(å¸ƒå±€),draw(ç»˜åˆ¶)ã€‚å…·ä½“æ˜¯æ˜¯ï¼šDecorvieçš„measure()ä¸­åˆè°ƒç”¨onMeasure()ï¼Œå®ç°å¯¹å…¶æ‰€æœ‰å­å…ƒç´ çš„measureè¿‡ç¨‹ï¼Œè¿™æ ·å°±å®Œæˆäº†DecorViewçš„æµ‹é‡è¿‡ç¨‹ï¼›æ¥ç€Viewæ ‘ä¸­çš„å­å…ƒç´ ä¼šé‡å¤çˆ¶å®¹å™¨çš„measureè¿‡ç¨‹ï¼Œå¦‚æ­¤åå¤è‡³å®Œæˆæ•´ä¸ªViewæ ‘çš„éå†ã€‚layoutå’ŒdrawåŒç†ã€‚
  - ![image-20241121145622442](./../_pic_/image-20241121145622442.png)
  - ViewRootå¯¹åº”äºViewRootImplç±»ï¼Œå®ƒæ˜¯è¿æ¥WindowManagerå’ŒDecorViewçš„çº½å¸¦ã€‚
- æ¯”è¾ƒé‡è¦çš„æ¦‚å¿µ
  - ViewRootï¼šè¿æ¥WindowManager(å¤–ç•Œè®¿é—®Windowçš„å…¥å£)å’ŒDecorViewï¼ˆé¡¶çº§Viewï¼‰çš„çº½å¸¦ï¼ŒViewçš„ä¸‰å¤§æµç¨‹å‡æ˜¯é€šè¿‡ViewRootæ¥å®Œæˆçš„ã€‚
  - DecorViewï¼šé¡¶çº§View
    - DecorViewæ˜¯é¡¶çº§Viewï¼Œæœ¬è´¨å°±æ˜¯ä¸€ä¸ªFrameLayout
    - åŒ…å«äº†ä¸¤ä¸ªéƒ¨åˆ†ï¼Œæ ‡é¢˜æ å’Œå†…å®¹æ 
    - å†…å®¹æ idæ˜¯contentï¼Œä¹Ÿå°±æ˜¯activityä¸­setContentViewæ‰€è®¾ç½®çš„éƒ¨åˆ†ï¼Œæœ€ç»ˆå°†å¸ƒå±€æ·»åŠ åˆ°idä¸ºcontentçš„FrameLayoutä¸­
- Viewçš„ç»˜åˆ¶æ˜¯ä»ä¸Šå¾€ä¸‹ä¸€å±‚å±‚è¿­ä»£ä¸‹æ¥çš„ã€‚DecorView-->ViewGroupï¼ˆ--->ViewGroupï¼‰-->View ï¼ŒæŒ‰ç…§è¿™ä¸ªæµç¨‹ä»ä¸Šå¾€ä¸‹ï¼Œä¾æ¬¡measure(æµ‹é‡),layout(å¸ƒå±€),draw(ç»˜åˆ¶)ã€‚
  - ![image-20241121150115116](./../_pic_/image-20241121150115116.png)

## 02.Viewåº•å±‚ç»˜åˆ¶åŸç†

- ä¸Šè¿°çš„measureã€layoutå’Œdrawç­‰éƒ½æ˜¯Android Frameworkå±‚ã€‚ä½†æ˜¯ä»…å‡­è¿™äº›å¯æ˜¯æ— æ³•å®Œæˆæ•´ä¸ªç»˜åˆ¶è¿‡ç¨‹çš„ã€‚æ¯”å¦‚ï¼Œå›¾å½¢æ€ä¹ˆè½¬åŒ–ä¸ºåƒç´ ï¼Œä¸åŒå›¾å±‚å¦‚ä½•åˆæˆï¼Ÿäº‹å®ä¸Šï¼ŒViewçš„ç»˜åˆ¶ç”±ä¸‰ä¸ªå±‚æ¬¡çš„é…åˆå®ç°ï¼Œåˆ†åˆ«æ˜¯Android Frameworkå±‚ï¼ˆJavaå±‚ï¼‰ï¼Œå›¾å½¢é©±åŠ¨å±‚ï¼ˆNativeå±‚ï¼‰ï¼ŒLinuxç³»ç»Ÿå±‚ï¼ˆSurfaceFlingerï¼‰
- é¦–å…ˆæ˜¯Android Frameworkå±‚ï¼ˆJavaå±‚ï¼‰
  - è°ƒç”¨cpuå¤„ç†Viewæ ‘ç»“æ„ï¼Œæ‰§è¡Œ `measure`ã€`layout` è®¡ç®—ä»»åŠ¡
  - åœ¨Drawé˜¶æ®µç”Ÿæˆç»˜åˆ¶æŒ‡ä»¤ï¼ˆDisplay Listï¼‰ï¼Œå¹¶æäº¤Display Liståˆ°å›¾å½¢é©±åŠ¨é˜Ÿåˆ—

- ç„¶åæ˜¯å›¾å½¢é©±åŠ¨å±‚ï¼š
  - ä»é˜Ÿåˆ—è¯»å–Display List
  - æ …æ ¼åŒ–ï¼ˆå°†çŸ¢é‡å›¾å½¢è½¬ä¸ºåƒç´ ï¼‰
  -  æ‰§è¡Œæ¸²æŸ“æ“ä½œï¼Œå¹¶è¾“å‡ºåƒç´ æ•°æ®åˆ°å¸§ç¼“å†²åŒº

- æœ€åæ˜¯å†…æ ¸æœåŠ¡å±‚ï¼ˆSurfaceFlingerï¼‰ï¼šå…¶ä¼šåˆæˆå¤šä¸ªå›¾å±‚ï¼ˆå¦‚åº”ç”¨UIã€çŠ¶æ€æ ã€å¯¼èˆªæ ï¼‰ï¼Œå…·ä½“æ¥è¯´å¦‚ä¸‹ï¼š
  -  æ¥æ”¶å„å›¾å±‚çš„åƒç´ æ•°æ®
  - è¿›è¡Œåˆæˆæ“ä½œ
  - é€šè¿‡ç¡¬ä»¶æ··åˆå™¨ï¼ˆHWCï¼‰è¾“å‡ºåˆ°æ˜¾ç¤ºè®¾å¤‡


## 03.Viewå¡é¡¿ä¸¢å¸§åŸç†

- ç†è§£Viewç»˜åˆ¶çš„åº•å±‚åŸç†åï¼Œæˆ‘ä»¬å°±å¯ä»¥å°è¯•å»ç†è§£Viewä¸ºä»€ä¹ˆå¡é¡¿æ‰å¸§äº†ã€‚

- ä»€ä¹ˆæ˜¯æ‰å¸§ï¼š
  - å¯¹äº60fpsçš„æ˜¾ç¤ºï¼Œä¹Ÿå°±æ˜¯1så†…æ¸²æŸ“60æ¬¡ï¼Œä¹Ÿå°±æ˜¯å¤§æ¦‚æ¯éš”16msï¼ˆ1000 / 60ï¼‰å°±è¦æ¸²æŸ“ä¸€æ¬¡ã€‚Androidç³»ç»Ÿæ¯éš”16mså‘å‡ºVSYNCä¿¡å·ï¼Œè§¦å‘å¯¹UIè¿›è¡Œæ¸²æŸ“ï¼Œå¦‚æœæ¯æ¬¡æ¸²æŸ“éƒ½æˆåŠŸï¼Œè¿™æ ·å°±èƒ½å¤Ÿè¾¾åˆ°æµç•…çš„ç”»é¢æ‰€éœ€è¦çš„60fpsï¼ŒVSYNCæ˜¯Vertical Synchronizationï¼ˆå‚ç›´åŒæ­¥ï¼‰çš„ç¼©å†™ï¼Œæ˜¯ä¸€ç§å®šæ—¶ä¸­æ–­ï¼Œä¸€æ—¦æ”¶åˆ°VSYNCä¿¡å·ï¼ŒCPUå°±å¼€å§‹å¤„ç†å„å¸§æ•°æ®ã€‚
  
  - å¦‚æœæŸä¸ªæ“ä½œè¦èŠ±è´¹30msï¼Œæ€»è€—æ—¶è¶…è¿‡ **16ms**ï¼Œè¿™æ ·GPUæ— æ³•åœ¨ä¸‹ä¸€ä¸ªVSYNCä¿¡å·å‰å®Œæˆæ¸²æŸ“ã€‚ç³»ç»Ÿåªèƒ½ä¸¢å¼ƒå½“å‰æœªå®Œæˆçš„å¸§ï¼Œé‡å¤æ˜¾ç¤ºä¸Šä¸€å¸§ç”»é¢ã€‚è¿™å°±æ˜¯ä¸¢å¸§å¡é¡¿ã€‚
  
- Viewæ‰å¸§å¡é¡¿çš„åŸå› ä¸»è¦åˆ†ä¸ºï¼šcpué˜¶æ®µå’Œgpué˜¶æ®µï¼Œå…¶ä¸­cpué˜¶æ®µåˆ†ä¸ºè€—æ—¶å’ŒUIçº¿ç¨‹å¡é¡¿ã€‚GPUé˜¶æ®µåˆ™æ˜¯è´Ÿè½½å‹åŠ›å¤§ï¼Œæ— æ³•åŠæ—¶æ¸²æŸ“å‡ºæ¥ã€‚

  - cpué˜¶æ®µï¼š
    - è€—æ—¶ï¼š
      - å¸ƒå±€åµŒå¥—å±‚çº§è¿‡æ·±ï¼šæ¯ä¸ªè§†å›¾å±‚çº§éƒ½ä¼šå¢åŠ  `measure` å’Œ `layout` çš„å¤æ‚åº¦ã€‚è¿‡æ·±çš„åµŒå¥—å±‚çº§ï¼Œå¯¼è‡´ `measure` å’Œ `layout` é˜¶æ®µè€—æ—¶è¿‡é•¿ã€‚

    - UIçº¿ç¨‹å¡é¡¿ï¼š
      - åœ¨ UI çº¿ç¨‹ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œï¼ŒAndroidä¸­UIæ›´æ–°æ˜¯ä¾èµ–äºUIå•çº¿ç¨‹æ‰§è¡Œï¼Œå¦‚æœåœ¨é‡Œé¢æ‰§è¡Œæ’­æ”¾è§†é¢‘ç­‰è€—æ—¶ä»»åŠ¡ï¼Œä¼šé˜»å¡ UIçº¿ç¨‹è¿›è¡ŒUI æ›´æ–°çš„æ“ä½œã€‚
  
      - GCï¼ˆåƒåœ¾å›æ”¶ï¼‰æš‚åœæ—¶é—´è¿‡é•¿æˆ–è€…é¢‘ç¹çš„GCäº§ç”Ÿå¤§é‡çš„æš‚åœæ—¶é—´ã€‚å…¶ä¸­GC æš‚åœä¼šæš‚åœåº”ç”¨çº¿ç¨‹ï¼Œè€Œé¢‘ç¹çš„GCæ˜¯æŒ‡æ¯”å¦‚åœ¨OnDrawä¸­åˆ†é…å¯¹è±¡ï¼Œå…¶æ¯æ¬¡ç»˜åˆ¶éƒ½ä¼šè°ƒç”¨ï¼Œæ‰§è¡Œå®Œæˆåéƒ½ä¼šå›æ”¶ï¼Œä¼šå¯¼è‡´é¢‘ç¹çš„å†…å­˜åˆ†é…å’Œåƒåœ¾å›æ”¶ï¼ˆGCï¼‰ã€‚


  - gpué˜¶æ®µï¼š

    - åŠ¨ç”»è¿‡äºå¤æ‚ï¼šåŠ¨ç”»æ•ˆæœå¤æ‚ï¼Œè¿‡åº¦ç»˜åˆ¶ï¼Œä½¿å¾—GPUè´Ÿè½½å‹åŠ›å¤§ï¼Œæ— æ³•åŠæ—¶æ¸²æŸ“å‡ºæ¥ã€‚


## 04.è‡ªå®šä¹‰Viewä¼˜åŒ–ç­–ç•¥

ä¸ºäº†åŠ é€Ÿä½ çš„Viewï¼Œä½ è¦åšåˆ°ç¬¦åˆå¦‚ä¸‹è¦æ±‚ï¼š

- **æ‰å¹³åŒ–è§†å›¾å±‚çº§**ï¼šæ¯ä¸ªè§†å›¾å±‚çº§éƒ½ä¼šå¢åŠ  `measure` å’Œ `layout` çš„å¤æ‚åº¦ã€‚æ‰å¹³åŒ–è§†å›¾å±‚çº§å¯ä»¥å‡å°‘measureå’Œlayoutçš„è°ƒç”¨

- **è‡ªå®šä¹‰ ViewGroup ä¼˜åŒ–å¸ƒå±€é€»è¾‘**ï¼šé»˜è®¤çš„ `ViewGroup` æµ‹é‡é€»è¾‘ä¼šéå†æ‰€æœ‰å­è§†å›¾ï¼Œå¯èƒ½é€ æˆæ€§èƒ½æµªè´¹ã€‚æˆ‘ä»¬å¯ä»¥ é€šè¿‡è‡ªå®šä¹‰ViewGroupçš„æµ‹é‡é€»è¾‘æ¥ä¼˜åŒ–æ€§èƒ½

- **é¿å…åœ¨ `onDraw` ä¸­åˆ†é…å¯¹è±¡**ï¼šè¿™ä¼šå¯¼è‡´é¢‘ç¹çš„å†…å­˜åˆ†é…å’Œåƒåœ¾å›æ”¶ï¼ˆGCï¼‰ã€‚

- **ä¼˜åŒ–`invalidate`**ï¼šè°ƒç”¨ `invalidate()` ä¼šè§¦å‘ `onDraw`ï¼Œè¿‡äºé¢‘ç¹çš„ `invalidate()` è°ƒç”¨ä¼šå¢åŠ  CPU å’Œ GPU çš„è´Ÿæ‹…ã€‚å› æ­¤è¦ç¬¦åˆå¦‚ä¸‹è¦æ±‚ï¼š
  
  - é¿å…ä¸å¿…è¦çš„ `invalidate()` è°ƒç”¨ã€‚
  - å¦‚æœåªéœ€è¦æ›´æ–°éƒ¨åˆ†åŒºåŸŸï¼Œä½¿ç”¨å¸¦å››ä¸ªå‚æ•°çš„ `invalidate(left, top, right, bottom)` æ–¹æ³•ï¼Œé™åˆ¶é‡ç»˜åŒºåŸŸã€‚
  

## å…¶ä»–ä»‹ç»

### 01.å…³äºæˆ‘çš„åšå®¢

- csdnï¼šhttp://my.csdn.net/qq_35829566

- æ˜é‡‘ï¼šhttps://juejin.im/user/499639464759898

- githubï¼šhttps://github.com/jjjjjjava

- ç®€ä¹¦ï¼šhttp://www.jianshu.com/u/92a2412be53e

- é‚®ç®±ï¼š[934137388@qq.com]



```
fix(Project): BaseActivityå­˜åœ¨çš„å†…å­˜æ³„æ¼çš„é—®é¢˜ï¼Œæ ¹æœ¬åŸå› æ˜¯ScrollImageViewä¸­æœ‰ä¸ªåŠ¨ç”»æŒæœ‰BaseActivityçš„å¼•ç”¨ã€‚
```

```
 public void startScrollAnimation(int direction, long duration) {
        mDirection = direction;
        
        // å…ˆæ¸…ç†ä¹‹å‰çš„åŠ¨ç”»
        if (mAnimator != null) {
            mAnimator.cancel();
            mAnimator = null;
        }
        
        Bitmap currentBitmap = mDirection == 1 ? mBitmapLeft : mBitmapRight;
        if (currentBitmap != null && !currentBitmap.isRecycled()) {
            mAnimator = ValueAnimator.ofFloat(0, currentBitmap.getWidth());
            mAnimator.setDuration(duration);
            mAnimator.addUpdateListener(animation -> {
                mUnrolledWidth = (float) animation.getAnimatedValue();
                invalidate();
            });
            mAnimator.start();
        }
    }
    
    @Override
    protected void onDetachedFromWindow() {
        super.onDetachedFromWindow();
        // ğŸ¯ æœ€ä¼˜é›…çš„ä¿®å¤ï¼šå–æ¶ˆåŠ¨ç”»ï¼Œæ–­å¼€æ³„æ¼é“¾è·¯
        if (mAnimator != null) {
            mAnimator.cancel();
        }
    }
```

