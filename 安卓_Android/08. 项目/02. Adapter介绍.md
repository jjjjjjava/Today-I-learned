## 1.PagerAdapterå’ŒRecyclerAdapter

### 1.1 æ•´ä½“ä»‹ç»

- PagerAdapteré€šå¸¸ç”¨äºViewPagerï¼Œç®¡ç†å¤šä¸ªé¡µé¢çš„åˆ‡æ¢ï¼Œè€ŒRecyclerAdapterç”¨äºRecyclerViewï¼Œè´Ÿè´£æ»šåŠ¨åˆ—è¡¨ä¸­åˆ—è¡¨é¡¹çš„æ˜¾ç¤ºå’Œæ•°æ®å¤„ç†ã€‚
- **PagerAdapter**ä¼šå¤ç”¨ç›¸é‚»é¡µé¢å¤ç”¨ï¼ˆé»˜è®¤ä¿ç•™å·¦å³å„1é¡µï¼‰ï¼ŒRecyclerAdapteråˆ™é€šè¿‡ViewHolderæœºåˆ¶è¿›è¡Œè§†å›¾å¤ç”¨

### 1.2 RecyclerAdapteræ•´ä½“ç»“æ„

- è¦æƒ³ç†è§£RecyclerAdapterï¼Œä½ éœ€è¦å…ˆç†è§£RecyclerViewï¼Œå…¶æœ‰ViewGroupï¼Œæœ‰å¸ƒå±€æ–¹å¼ï¼Œæœ‰å­Viewï¼Œæœ‰æ•°æ®é›†åˆã€‚
  - é€šè¿‡å¸ƒå±€æ–¹å¼è®¾ç½®å­Viewåœ¨ViewGroupçš„æ˜¾ç¤ºæ–¹å¼ã€‚è€Œå­Viewé€šè¿‡ç»‘å®šæ•°æ®é›†åˆä¸­çš„æ•°æ®æ¥æ˜¾ç¤ºå†…å®¹ã€‚
- å› æ­¤å¯¹äºRecyclerAdapterï¼Œå…¶æœ‰ä»¥ä¸‹å…³é”®ç»„ä»¶ã€‚
  - RecyclerView.Adapter - è‡ªåŠ¨åŒ–å¤„ç†æ•°æ®é›†åˆå¹¶è´Ÿè´£ç»‘å®šè§†å›¾
  - ViewHolder - æŒæœ‰æ‰€æœ‰çš„ç”¨äºç»‘å®šæ•°æ®çš„View
  - LayoutManager - è´Ÿè´£æ‘†æ”¾è§†å›¾ç­‰ç›¸å…³æ“ä½œ
- å½“ç„¶è¿˜æœ‰**ItemDecoration** ç»˜åˆ¶åˆ†å‰²çº¿ç­‰ï¼Œåœ¨æ­¤ä¸åšè¿‡å¤šèµ˜è¿°ã€‚
  - ![image-20250219162743739](./../_pic_/image-20250219162743739.png)
- okï¼Œæˆ‘ä»¬è¯´äº†RecyclerAdapterçš„å…³é”®ç»„ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯¥æ€ä¹ˆç†è§£ä»–ä»¬ä¹‹é—´çš„å…³ç³»æˆ–è€…è¯´å·¥ä½œæ¨¡å¼å‘¢ï¼Ÿ
  - å…·ä½“å¦‚ä¸‹ï¼šRecyclerViewæ˜¯æ•´ä½“çš„åˆ—è¡¨ï¼Œè§†ä½œä¸€ä¸ªViewGroupã€‚é‡Œé¢çš„æ¯ä¸ªæ¡ç›®éƒ½æ˜¯å…¶ä¸€ä¸ªå­Viewï¼Œæ¡ç›®ç”±ViewHolderå®¹çº³ã€‚viewéœ€è¦ç»‘å®šæ•°æ®ï¼Œæˆ‘ä»¬å°†æ•°æ®é›†åˆä¼ é€’ç»™Adapterã€‚åœ¨å…¶å†…éƒ¨çš„onBindViewHolderé€»è¾‘ä¸­ï¼Œè®¾ç½®å•æ¡æ•°æ®å¦‚ä½•å¡«å……å•ä¸ªViewHolderæ¡ç›®ã€‚åˆ—è¡¨é€šè¿‡LayoutManager ç®¡ç†æ¡ç›®å¸ƒå±€ã€‚
  - ä¸¾ä¾‹ï¼šå¯¹äºå½“å‰ä¸€ä¸ªç½‘æ ¼å±å¹•ï¼Œé‡Œé¢åˆ†ä¸¤æ’ï¼Œå‚ç›´æ˜¾ç¤º6ä¸ªè§†é¢‘ã€‚è¿™æ˜¯é€šè¿‡LayoutManager ç®¡ç†æ¡ç›®å¸ƒå±€ã€‚è¿™æ¯ä¸ªè§†é¢‘å°±æ˜¯ä¸€ä¸ªå­Viewï¼Œæ˜¯ä¸€ä¸ªViewHolderã€‚ä»–ä»¬æ˜¾ç¤ºåœ¨è¿™ä¸ªå¤§çš„RecyclerViewè¿™ä¸ªViewGroupä¸Šã€‚æ¯ä¸ªè§†é¢‘è¦æœ‰è§†é¢‘æ¥æºï¼Œç®€ä»‹ç­‰ï¼Œè¿™äº›è¢«å­˜æ”¾åœ¨æ•°æ®é›†åˆä¸­ï¼Œæˆ‘ä»¬æŠŠæ•°æ®ç»“åˆä¼ é€’ç»™Adapterï¼Œåœ¨å…¶å†…éƒ¨çš„onBindViewHolderé€»è¾‘ä¸­ï¼Œè®¾ç½®å•æ¡æ•°æ®å¦‚ä½•å¡«å……å•ä¸ªViewHolderæ¡ç›®ã€‚ã€‚

### 1.3 ViewHolderä½œç”¨

- ViewHolderæ ¸å¿ƒä½œç”¨æ˜¯å®ç°è§†å›¾å¤ç”¨ã€‚å®ƒèº«æ˜¯æ¡ç›®è§†å›¾çš„å®¹å™¨ã€‚å®¹çº³æ¡ç›®è§†å›¾ã€‚

  - è€ƒè™‘ä¸€ä¸ªæ²¡æœ‰ViewHolderçš„æƒ…å†µï¼Œå¯¹äºRecyclerViewï¼Œå…¶æ˜¯ä¸€ä¸ªViewGroupï¼Œå†…éƒ¨åŒ…å«å¤šä¸ªå­Viewã€‚æˆ‘ä»¬è¿›è¡Œæ»‘åŠ¨æ“ä½œï¼Œå¦‚æœæ²¡æœ‰ViewHolderï¼Œé‚£ä¹ˆæ¯æ¬¡æ»‘åŠ¨åˆ°æ–°çš„ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨åœ¨adapteré€»è¾‘ä¸­åˆ›å»ºä¸€ä¸ªViewå®ä¾‹ï¼Œå¹¶å°†adapterä¸­çš„æ•°æ®æºè¾“å…¥åˆ°å¸ƒå±€ä¸­ã€‚åŒæ—¶æ—§çš„ä¼šè¢«é”€æ¯ã€‚è€Œæœ‰äº†ViewHolderï¼Œå…¶å¯ä»¥å®¹çº³å­Viewï¼Œåˆå› ä¸ºæ–°æ—§ä»–ä»¬çš„å¸ƒå±€é€»è¾‘éƒ½ä¸€æ ·ï¼Œæ‰€ä»¥åªéœ€è¦é€šè¿‡onBindViewHolderæ›´æ–°æ—§çš„ä¸­çš„æ•°æ®å³å¯ã€‚

- è‹¥æ—  ViewHolder æœºåˆ¶ï¼Œæ¯æ¬¡åˆ—è¡¨æ»‘åŠ¨å¯¼è‡´æ–°æ¡ç›®è¿›å…¥å±å¹•æ—¶ï¼Œç³»ç»Ÿä¼šï¼š

  - ğŸ“‰ **é¢‘ç¹è°ƒç”¨ `inflate()`**ï¼šXML è§£æå’Œ View å¯¹è±¡åˆ›å»ºï¼ˆè€—æ—¶æ“ä½œï¼‰
  - ğŸ“‰ **é‡å¤æ‰§è¡Œ `findViewById()`**ï¼šéå†è§†å›¾æ ‘æŸ¥æ‰¾å­ Viewï¼ˆCPU å¯†é›†å‹ï¼‰
  - ğŸ“‰ **å†…å­˜æŠ–åŠ¨**ï¼šå¤§é‡ä¸´æ—¶ View å¯¹è±¡çš„åˆ›å»ºå’Œ GC å›æ”¶å½±å“æµç•…åº¦

- **ViewHolder çš„è§£å†³æ–¹æ¡ˆ**

  - âœ…å¤ç”¨è§†å›¾å¯¹è±¡ï¼šé€šè¿‡ç¼“å­˜å·²åˆ›å»ºçš„ View å®ä¾‹ï¼Œé¿å…é‡å¤inflate()å’ŒfindViewById

    ```
    // æ—  ViewHolder çš„ä¼ªä»£ç ï¼ˆä½æ•ˆï¼‰
    fun getView(position: Int) {
        val view = inflate(R.layout.item) // æ¯æ¬¡åˆ›å»ºæ–°å¯¹è±¡
        val textView = view.findViewById<TextView>(R.id.tv)
        textView.text = data[position]
        return view
    }
    ```

  - âœ…ç¼“å­˜å­ View å¼•ç”¨ï¼šViewHolder å†…éƒ¨ä¿å­˜findViewByIdç»“æœï¼Œé¿å…é‡å¤æŸ¥æ‰¾

    ```
    class ViewHolder(itemView: View) {
        // åªæ‰§è¡Œä¸€æ¬¡ findViewById
        val textView: TextView = itemView.findViewById(R.id.tv)
    }
    ```

  - **RecyclerView çš„å®é™…æµç¨‹**
    æ»‘åŠ¨æ—¶å¤„ç†é€»è¾‘ï¼š

    ```
    // Adapter æ ¸å¿ƒæ–¹æ³•
    override fun onCreateViewHolder(...): ViewHolder {
        // ä»…å½“æ— ç¼“å­˜å¯ç”¨æ—¶è§¦å‘ï¼ˆä½é¢‘ï¼‰
        val itemView = LayoutInflater.inflate(R.layout.item, ...)
        return ViewHolder(itemView) // åˆå§‹åŒ–æ—¶æ‰§è¡Œä¸€æ¬¡ findViewById
    }
    
    override fun onBindViewHolder(holder: ViewHolder, position: Int) {
        // é«˜é¢‘è°ƒç”¨ï¼Œä½†åªéœ€æ›´æ–°æ•°æ®
        holder.textView.text = data[position]
    }
    ```

- **å…³é”®å¯¹æ¯”**ï¼š

  | **åœºæ™¯**     | æ—  ViewHolder             | æœ‰ ViewHolder                  |
  | ------------ | ------------------------- | ------------------------------ |
  | è§†å›¾åˆ›å»º     | æ¯æ¬¡æ»‘åŠ¨æ–°å»º View         | å¤ç”¨ç¼“å­˜ View                  |
  | å­ View æŸ¥æ‰¾ | æ¯æ¬¡æ»‘åŠ¨æ‰§è¡Œ findViewById | ä»…åœ¨ ViewHolder åˆ›å»ºæ—¶æ‰§è¡Œä¸€æ¬¡ |
  | å†…å­˜æ•ˆç‡     | ä½ï¼ˆé¢‘ç¹ GCï¼‰             | é«˜ï¼ˆå¯¹è±¡å¤ç”¨ï¼‰                 |

## 02.DiffUtil

- å†çœ‹ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼Œå‡å¦‚ç”¨æˆ·åœ¨å½“å‰å­Viewä¸­è¿›è¡Œäº†ç‚¹èµæ“ä½œï¼Œå¯¼è‡´åå°æ•°æ®åº“ä¸­è§†é¢‘åˆ—è¡¨çš„ç‚¹èµæ•°æ›´æ–°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•æ›´æ–°è¿™ä¸ªå­Viewå‘¢ï¼Ÿæ˜¯ä½¿ç”¨notifyDataSetChangedå›è°ƒå—ï¼Ÿè¿™ä¸æ˜¯æœ€ç¬¨çš„æ–¹æ³•å—ï¼Ÿæœ‰å…¶å®ƒæ›´å¥½çš„å—ï¼Ÿæœ‰çš„ï¼Œæˆ‘ä»¬é€šè¿‡DiffUtil ç±»å®ç°ã€‚ç±»å†…éƒ¨æœ‰ä¸¤ä¸ªæ–¹æ³•

  - `areItemsTheSame()`é€šè¿‡æ¯”è¾ƒ `userBean.uid` çš„ç›¸ç­‰æ€§ï¼Œåˆ¤æ–­ä¸¤ä¸ª Item æ˜¯å¦ä»£è¡¨ **åŒä¸€ä¸ªå¯¹è±¡**ï¼ˆä¾‹å¦‚ï¼Œæ˜¯å¦å¯¹åº”åŒä¸€ä¸ªç”¨æˆ·ï¼‰ã€‚

  - `areContentsTheSame()`åœ¨ç¡®è®¤æ˜¯åŒä¸€ä¸ª Item åï¼Œåˆ¤æ–­åŒä¸€æ•°æ®å®ä½“çš„å†…å®¹æ˜¯å¦æœ‰å˜åŒ–ï¼ˆæ˜¯å¦éœ€è¦æ›´æ–° UIï¼‰ã€‚

  - ```
    class VideoDiff : DiffUtil.ItemCallback<VideoBean>() {
        override fun areItemsTheSame(oldItem: VideoBean, newItem: VideoBean): Boolean {
            return (oldItem.userBean!!.uid == newItem.userBean!!.uid)
        }
    
        override fun areContentsTheSame(oldItem: VideoBean, newItem: VideoBean): Boolean {
            return (oldItem.videoRes == newItem.videoRes && oldItem.userBean!!.uid == newItem.userBean!!.uid)
        }
    }
    ```

  - å‡è®¾æ•°æ®é›†ä» `oldList` å˜ä¸º `newList`ï¼ŒDiffUtil ä¼šæŒ‰ä»¥ä¸‹æ­¥éª¤å¯¹æ¯”ï¼š

    - **éå†æ–°æ—§åˆ—è¡¨**ï¼Œé€šè¿‡ `areItemsTheSame` åˆ¤æ–­æ˜¯å¦ä¸ºåŒä¸€ Itemã€‚
    - è‹¥ä¸ºåŒä¸€ Itemï¼Œè°ƒç”¨ `areContentsTheSame` æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–° UIã€‚
    - æœ€ç»ˆç”Ÿæˆä¸€ä¸ªå·®å¼‚æŠ¥å‘Š (`DiffResult`)ï¼ŒåŒ…å«æ’å…¥ã€åˆ é™¤ã€ç§»åŠ¨ã€æ›´æ–°çš„ä½ç½®ä¿¡æ¯ã€‚
    - Adapter æ ¹æ® `DiffResult` è°ƒç”¨ `notifyItemRangeInserted` ç­‰æ–¹æ³•å±€éƒ¨æ›´æ–°ã€‚

- **DiffUtilé—ªå…‰ç‚¹**ï¼š

  - é¦–å…ˆä»notifyDataSetChangedæ›´æ”¹ä¸ºVideoDiffï¼Œæ¯æ¬¡æ•°æ®æ›´æ–°éƒ½è§¦å‘å®Œæ•´çš„onBindViewHolderã€‚

  - å…¨å±€notifyDataSetChangedæ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿä¸ºä»€ä¹ˆä½¿ç”¨VideoDiffç›¸å¯¹äºå®ƒçš„æå‡è¿™ä¹ˆå¤§ï¼Ÿ

    - DiffUtilåªæ¶‰åŠæ¡ç›®çº§åˆ«çš„æ›´æ–°ï¼Œä»¥åŠä½¿ç”¨payloadè¿›è¡Œæ›´ç»†ç²’åº¦çš„æ›´æ–°ã€‚éœ€è¦ä¸¾ä¾‹è¯´æ˜ï¼Œæ¯”å¦‚ä¸€ä¸ªæœ‰1000é¡¹çš„åˆ—è¡¨ï¼Œåªæœ‰ä¸€é¡¹å˜åŒ–æ—¶ï¼ŒDiffUtilåªä¼šæ›´æ–°é‚£ä¸€é¡¹ï¼Œè€ŒnotifyDataSetChangedä¼šè§¦å‘å…¨éƒ¨1000é¡¹çš„é‡æ–°ç»‘å®šã€‚

  - å†ä¼˜åŒ–ï¼šé€šè¿‡getChangePayloadï¼Œå®ç°ä»…æ›´æ–°ç‚¹èµæ•°å­—ï¼Œè€Œä¸é‡ç»˜æ•´ä¸ªItem

  - ```
    // åœ¨ VideoDiff ä¸­æ·»åŠ 
    override fun getChangePayload(oldItem: VideoBean, newItem: VideoBean): Any? {
        return if (oldItem.likeCount != newItem.likeCount) {
            Bundle().apply { putInt("LIKE_COUNT", newItem.likeCount) }
        } else {
            super.getChangePayload(oldItem, newItem)
        }
    }
    
    // åœ¨ Adapter ä¸­å¤„ç†å±€éƒ¨æ›´æ–°
    override fun onBindViewHolder(holder: ViewHolder, position: Int, payloads: List<Any>) {
        if (payloads.isNotEmpty()) {
            (payloads[0] as? Bundle)?.getInt("LIKE_COUNT")?.let { 
                holder.updateLikeCount(it) // ä»…æ›´æ–°ç‚¹èµæ•°è§†å›¾
            }
        } else {
            super.onBindViewHolder(holder, position, payloads)
        }
    }
    ```

  - | **åˆ·æ–°æ–¹å¼**                | 1000 æ¡æ•°æ®åˆ·æ–°è€—æ—¶ | å†…å­˜æ³¢åŠ¨ |
    | --------------------------- | ------------------- | -------- |
    | å…¨å±€ `notifyDataSetChanged` | 120 ms              | é«˜       |
    | ä½¿ç”¨ `VideoDiff`            | 15 ms               | ä½       |
