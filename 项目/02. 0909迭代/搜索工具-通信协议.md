# 搜索工具协议集合


	报文格式：以太网首部+IP头部+UDP头部+"NDT1"+TDTHeader+自定义结构体内容
	发送采用：广播+组播（主要用于搜索），单播(主要用于修改设备网络参数)
             广播地址：255.255.255.255  5513
		 组播地址： 224.16.32.1     5510

		 接收udp网络包：过滤5513端口网络包

	IP+UDP协议报文头部
	14字节以太网首部+20字节IP协议头+8字节UDP协议 请求/应答（广播）：
	14字节以太网首部
	EthernetHeader
	{
		u_char DestMAC[6]; /* 目的MAC地址 6字节 */
		u_char SourMAC[6]; /* 源MAC地址 6字节 */
		u_short EthType;   /* 上一层协议类型，如0x0800代表上一层是IP协议，0x0806为arp  2字节 */
	}
	/* 20字节UDP帧结构 */
	typedef struct ip_hdr
	{
		uint8_t ip_verlen;		// IP version & length
		uint8_t ip_tos;			// IP type of service
		uint16_t ip_totallength; // Total length
		uint16_t ip_id;			// Unique identifier
		uint16_t ip_offset;		// Fragment offset field
		uint8_t ip_ttl;			// Time to live
		uint8_t ip_protocol;		// Protocol(TCP,UDP etc)
		uint16_t ip_checksum;	// IP checksum
		uint32_t ip_srcaddr;		// Source address
		uint32_t ip_destaddr;	// Destination address
	} 
	/* 8字节UDP帧结构 */
	typedef struct udphdr
	{
		uint16_t src_portno;   // Source port number
		uint16_t dst_portno;   // Destination port number
		uint16_t udp_length;   // UDP packet length
		uint16_t udp_checksum; // UDP checksum (optional)
	} 

	双端对消息校验：NDT1:广播消息'NDT1'-NVR Device Track 1.0 头
	TDTHeader  wMsgID 消息标志，用以判断消息类型
	{
		uint8_t  abyMacSrc[6];  // 发送者MAC地址 
		uint8_t  abyMacDst[6];  // 接收者MAC地址
		uint16_t wMsgID;        // 消息ID
	}
	
### [1. 广播搜索]
	1、设备探测广播消息
	“NDT1”+ TDTHeader

	消息标志 wMsgID = 0x0001
	{
		uint8_t  abyMacSrc[6];  // 发送者MAC地址 
		uint8_t  abyMacDst[6];  // 接收者MAC地址
		uint16_t wMsgID;        // 消息ID
	}

	2、设备探测广播应答
	“NDT1”+TDTHeader+TDTDevInfo+TDTDevID+TDTDevType

	消息标志 wMsgID = 0x0002
	TDTHeader
	{
		uint8_t  abyMacSrc[6];  // 发送者MAC地址 
		uint8_t  abyMacDst[6];  // 接收者MAC地址
		uint16_t wMsgID;        // 消息ID
	}

	TDTDevInfo
	{
		struct TDTDevAddr tAddr;    // IP、MASK、GW
		uint32_t dwTickCount;   // 运行时间
		uint32_t dwBrdID;       // 设备类型ID
		struct TDTDvsRegPlat tRegPlat;  // 前端注册平台参数
		uint8_t byDevIdMask;        // 标识后续是否有DevId信息(1:有;0:无)
		uint8_t byDevTypeMask;  // 是否有设备类型字符串(1:有;0:无)，为1时，设备信息在TDTDevID后还有TDTDevType信息
		uint8_t bySrvTypeMask;      // 服务提供类型（0:IPC(ipdt)，1:VS前端(KDMSearch))
		uint8_t byMask3;                //判断升级系列modify by xuqinglai at 20101213
		uint32_t dwReserved2;
	}
	
	//uint32_t dwBrdID 设备类型ID补充
	{
		|--------|--------|----------------|
		| maigc  | devtype|  capacity_list |
		|--------|--------|----------------|
		|  1bit  |  6bit  |      25bit     |	

            能力集列表
            capacity_list [24:0]

            能力集定义
            capacity_list[24]
            1: 支持自研rtsp格式接入 (rtsp://{IP}/live/main, rtsp://{IP}/live/sub)
            0: 不支持
	}

	TDTDevAddr
	{
		// DHCP服务器类型，第一字节: 0-没有DHCP服务 1-服务器，2-客户端
		// 第二字节: 0-关闭 1-开启；例如：0x0000表示没有服务器，0x0201表示客户端(开启)
		uint16_t wDHCPOpen; // 0-关闭 1-开启DHCP
		uint32_t dwIpaddr;      // IP地址，网络序
		uint32_t dwNetmask;     // 子网掩码，网络序
		uint32_t dwGateWay;     // 默认网关，网络序
	}

	// 设备名称
	TDTDevID
	{
		char achDevName[DT_LEN_NAME + 1];   // 设备名称
		char achDevSerial[11];
	}

	// 设备型号
	TDTDevType
	{
		char achDevType[DT_LEN_NAME + 1];   // 设备类型名称
	}

	//版本号 (抓包看当TDTDevInfo.byDevIdMask>1 && 网络包>246时有版本号)
	{
	       char  szSoftVersion[32]
	}

### [2. 修改设备地址信息]
	1、修改设备地址通知
	“NDT1”+TDTHeader+TDTDevNetParam

	消息标志 wMsgID = 0x0003
	TDTHeader
	{
		uint8_t  abyMacSrc[6];  // 发送者MAC地址 
		uint8_t  abyMacDst[6];  // 接收者MAC地址
		uint16_t wMsgID;        // 消息ID固定 -->0x0001
	}

	TDTDevNetParam
	{
		uint32_t dwNetMask; // DT_NETMASK_MODADDR -表示地址有效 DT_NETMASK_MODREGPLAT-表示注册地址有效，需要修改
		struct TDTDevAddr tAddr;    // IP、MASK、GW
		struct TDTDvsRegPlat tRegPlat;  // 前端注册平台参数
		uint32_t dwReserved1;
		uint32_t dwReserved2;
	}
 
    TDTDvsRegPlat
	{
		uint8_t byRegIPType;  // 注册地址类型, 0-ip地址、 1-dns
		uint8_t byIsCMS;            // 是否启用负载均衡， 0-不启用，1-启用
		uint32_t dwRegIP;   // 网络序，负载均衡的IP以及平台的ip地址公用
		int8_t  achRegDNS[DT_LEN_DNS]; // 注册平台DNS
		uint16_t wRegPort;  // 注册平台端口，只有在启用负责均衡时才需修改，其他默认5510
	}

	2、修改设备地址应答
	“NDT1”+TDTHeader+uint32_t(ErrorCode) // ErrorCode 默认为0代表成功

	消息标志 wMsgID = 0x0004
	TDTHeader
	{
		uint8_t  abyMacSrc[6];  // 发送者MAC地址 
		uint8_t  abyMacDst[6];  // 接收者MAC地址
		uint16_t wMsgID;        // 消息ID
	}

### [3. 设备重启]
	1、设备重启通知
	“NDT1”+TDTHeader
	消息标志 wMsgID = 0x0005
	TDTHeader
	{
		uint8_t  abyMacSrc[6];  // 发送者MAC地址 
		uint8_t  abyMacDst[6];  // 接收者MAC地址
		uint16_t wMsgID;        // 消息ID
	}
	//设备接收到重启消息，无需回复，直接重启

### [4. 获取版本信息]
	1、获取版本信息通知
	“NDT1”+TDTHeader
	消息标志 wMsgID = 0x0006
	TDTHeader
	{
		uint8_t  abyMacSrc[6];  // 发送者MAC地址 
		uint8_t  abyMacDst[6];  // 接收者MAC地址
		uint16_t wMsgID;        // 消息ID
	}

	2、获取版本信息应答
	“NDT1”+TDTHeader+achVersion[32]
	消息标志 wMsgID = 0x0007
	TDTHeader
	{
		uint8_t  abyMacSrc[6];  // 发送者MAC地址 
		uint8_t  abyMacDst[6];  // 接收者MAC地址
		uint16_t wMsgID;        // 消息ID
	}

### [5. 获取升级信息]
	1、获取升级信息通知
	“NDT1”+TDTHeader
	消息标志 wMsgID = 0x000A
	TDTHeader
	{
		uint8_t  abyMacSrc[6];  // 发送者MAC地址 
		uint8_t  abyMacDst[6];  // 接收者MAC地址
		uint16_t wMsgID;        // 消息ID
	}

	2、获取升级信息应答
	“NDT1”+TDTHeader+TDTFtpUpdateInfo
	消息标志 wMsgID = 0x000B
	TDTHeader
	{
		uint8_t  abyMacSrc[6];  // 发送者MAC地址 
		uint8_t  abyMacDst[6];  // 接收者MAC地址
		uint16_t wMsgID;        // 消息ID
	}

	TDTFtpUpdateInfo
	{
		uint16_t wFileType;
		uint32_t dwFtpServerIp;
		uint16_t wFtpServerPort;
		int8_t achFtpUser[DT_LEN_FTP_USER];
		int8_t achFtpPasswd[DT_LEN_FTP_PASSWD];
		int8_t achFilePath[DT_LEN_FILE_PATH];
	}

### [6. FTP升级]
	1、FTP升级通知
	“NDT1”+TDTHeader+TDTFtpUpdateInfo
	消息标志 wMsgID = 0x0008
	TDTHeader
	{
		uint8_t  abyMacSrc[6];  // 发送者MAC地址 
		uint8_t  abyMacDst[6];  // 接收者MAC地址
		uint16_t wMsgID;        // 消息ID
	}

	TDTFtpUpdateInfo
	{
		uint16_t wFileType;
		uint32_t dwFtpServerIp;
		uint16_t wFtpServerPort;
		int8_t achFtpUser[DT_LEN_FTP_USER];
		int8_t achFtpPasswd[DT_LEN_FTP_PASSWD];
		int8_t achFilePath[DT_LEN_FILE_PATH];
	}

	2、获取升级信息应答
	“NDT1”+TDTHeader+uint32_t(ErrorCode)  //	ErrorCode默认为0
	消息标志 wMsgID = 0x0009
	TDTHeader
	{
		uint8_t  abyMacSrc[6];  // 发送者MAC地址 
		uint8_t  abyMacDst[6];  // 接收者MAC地址
		uint16_t wMsgID;        // 消息ID
	}


	