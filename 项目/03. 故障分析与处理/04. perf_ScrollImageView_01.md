[toc]

# å†…å­˜æ³„æ¼åˆ†ææŠ¥å‘Š

## 01. å½±å“æ¦‚è¿°

- **[ä¼˜å…ˆçº§]**
  - [ ] âš ï¸ é˜»æ–­ (Blocker)ï¼šç³»ç»Ÿå´©æºƒã€æ ¸å¿ƒåŠŸèƒ½å®Œå…¨ä¸å¯ç”¨
  - [ ] ğŸ”´ ä¸¥é‡ (Critical)ï¼šæ ¸å¿ƒåŠŸèƒ½å—æŸï¼Œæ— å¯ç”¨æ›¿ä»£æ–¹æ¡ˆ
  - [ ] ğŸŸ  é«˜ (High)ï¼šä¸»è¦åŠŸèƒ½å—å½±å“ï¼Œä½†æœ‰ä¸´æ—¶è§£å†³æ–¹æ¡ˆ
  - [ ] ğŸŸ¡ ä¸­ (Medium)ï¼šæ¬¡è¦åŠŸèƒ½é—®é¢˜ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ
  - [ ] ğŸŸ¢ ä½ (Low)ï¼šç•Œé¢é—®é¢˜æˆ–è½»å¾®å¼‚å¸¸ï¼Œä¸å½±å“åŠŸèƒ½
- **é—®é¢˜ç®€è¦æè¿°**
  - **Bug ID**ï¼š`BUG-20240801-001`
  - **å½±å“ç‰ˆæœ¬**ï¼šv5.26.01
  - **æäº¤äºº**ï¼š@panruiqi
  - **çŠ¶æ€**ï¼š
    - [x] âŒ› ä¿®å¤ä¸­ /
    - [ ] âœ… å·²è§£å†³ /
    - [ ] âŒ æ— æ³•å¤ç°
- **é—®é¢˜ç°è±¡**
  - 
- **ç¯å¢ƒç‰¹å¾**
  - è®¾å¤‡å‹å·/ç³»ç»Ÿç‰ˆæœ¬/ç½‘ç»œç¯å¢ƒ/ç‰¹æ®Šé…ç½®ç­‰

## 02.å¤ç°æ­¥éª¤

1. 
2. 
3. 
4. 

## 03.æ•°æ®é‡‡é›†

### 3.1 ç›¸å…³æ•°æ®

- [ ] dumpsys meminfo/procstats
- [ ] LeakCanary/Profiler/MATæˆªå›¾
  - [ ] ![image-20250801143257536](../../_pic_/image-20250801143257536.png)
- [ ] å…³é”®æ—¥å¿—/å †æ ˆ
- [ ] ç›¸å…³é…ç½®/ç¯å¢ƒä¿¡æ¯

### 3.1 é¢„åˆ†æ

å…³é”®æ—¥å¿—ç‰‡æ®µï¼š

ç›¸å…³å¼‚å¸¸å †æ ˆ/å†…å­˜å¿«ç…§/è­¦å‘Šä¿¡æ¯ï¼š

- ä»ä¸Šåˆ°ä¸‹å¯ä»¥å‘ç°RetainedSizeç»å¤§å¤šæ•°æ˜¯RecyclerViewå’ŒScrollImageViewæŒæœ‰ä»–çš„å¼•ç”¨æ‰€å¯¼è‡´çš„



## 04. æ³„æ¼å®šä½è¿‡ç¨‹

### 4.1 å…³é”®å‘ç°

å‘ç°çš„æ³„æ¼å¯¹è±¡ã€å¼•ç”¨é“¾ã€GC Rootç­‰

- æ³„æ¼å¯¹è±¡ï¼šDlqInfoActivityè¢«ScrollImageViewæŒæœ‰å¼•ç”¨

### 4.2 ä»£ç ä½ç½®

å…·ä½“ç±»/æ–¹æ³•/è¡Œå·/è°ƒç”¨é“¾

- ```
  DlqInfoActivity (éœ€è¦è¢«å›æ”¶)
      â†“ ç»§æ‰¿
  BaseMvpBindingActivity 
      â†“ ç»§æ‰¿  
  BaseActivity
      â†“ åˆ›å»ºå¹¶æŒæœ‰
  DragFloatActionNew2Button (ä¼ å…¥ this = Activity Context)
      â†“ å†…éƒ¨åŒ…å«
  ScrollImageView (æŒæœ‰ Context å¼•ç”¨)
  ```

å…³é”®ä»£ç è¯¦ç»†ä»‹ç»

- BaseActivityä¸­åˆ›å»ºScrollImageViewç±»å‹customerButton
  - ![image-20250801143604553](../../_pic_/image-20250801143604553.png)
- BaseActivityä¸­é€šè¿‡getWindow.addContentViewå°†customerButton
  - ![image-20250801144523497](../../_pic_/image-20250801144523497.png)

æ³„æ¼åŸå› è¯´æ˜ï¼š

- ```
  // Activity é”€æ¯æ—¶
  Activity.finish()
      â†“
  Activity.onDestroy() // Activity ç”Ÿå‘½å‘¨æœŸç»“æŸ
      â†“  
  Window ä»ç„¶å­˜åœ¨ï¼// âŒ Window ä¸ä¼šè‡ªåŠ¨æ¸…ç†é€šè¿‡ addContentView() æ·»åŠ çš„ View
      â†“
  customerButton ä»ç„¶åœ¨ Window ä¸­
      â†“
  customerButton æŒæœ‰ Activity Context
      â†“  
  âŒ Activity æ— æ³•è¢« GC å›æ”¶
  ```

çœŸçš„æ˜¯è¿™æ ·çš„å—ï¼Ÿ

- getWindow.addContentViewåˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿ

  - æŠŠ View åŠ åˆ° DecorViewï¼ˆé¡¶å±‚ FrameLayoutï¼‰é‡Œï¼ŒDecorView æ˜¯ Activity ç•Œé¢çš„æ ¹èŠ‚ç‚¹ã€‚
  - è¿™ä¸ª View ä¼šä¸€ç›´å­˜åœ¨äºç•Œé¢ä¸Šï¼Œç›´åˆ°ä½ æ‰‹åŠ¨ç§»é™¤å®ƒï¼ˆæ¯”å¦‚ removeView()ï¼‰ï¼Œæˆ–è€… Activity è¢«é”€æ¯ã€‚

- okï¼Œé‚£DecorViewå’ŒActivityä»€ä¹ˆå…³ç³»ï¼Ÿ

  - DecorView æ˜¯æ¯ä¸ª Activity ç•Œé¢çš„é¡¶çº§ Viewï¼Œæœ¬è´¨æ˜¯ä¸€ä¸ª FrameLayoutã€‚

  - DecorView ç»“æ„å¤§è‡´å¦‚ä¸‹ï¼ˆç®€åŒ–ï¼‰ï¼š

    - ```
      DecorView(FrameLayout)
      â”œâ”€â”€ TitleBarï¼ˆå¯é€‰ï¼‰
      â””â”€â”€ ContentParent(FrameLayout)  â† id=android.R.id.content
          â””â”€â”€ ä½  setContentView() è®¾ç½®çš„å¸ƒå±€
      ```

  - setContentView() å®é™…ä¸Šæ˜¯æŠŠä½ çš„å¸ƒå±€æ·»åŠ åˆ° ContentParentï¼ˆid=contentï¼‰è¿™ä¸ª FrameLayout é‡Œã€‚

  - ActivityæŒæœ‰DecorView

- é‚£ç›®å‰çš„GC å¼•ç”¨é“¾åº”è¯¥æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ

  - ```
    [GC Root]
       â†“
    [WindowManager]  // ç³»ç»ŸæœåŠ¡ï¼ŒGC Root
       â†“
    [Window]         // Activity çš„ Window
       â†“
    [DecorView]      // Activity çš„é¡¶çº§ View
       â†“
    [customerButton] // ä½  addContentView() åŠ è¿›å»çš„
       â†“
    [mContext]       // customerButton æŒæœ‰çš„ Contextï¼Œå…¶å®å°±æ˜¯ Activity
       â†“
    [DlqInfoActivity]// ä½ æƒ³è¢«å›æ”¶çš„ Activity
       â†‘
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€(ç¯)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    ```

- å¥½ï¼Œç°åœ¨é—®é¢˜æ¥äº†ï¼Œä½ ä½¿ç”¨finishï¼Œç†è®ºä¸ŠDecorViewä¼šè¢«æ¸…é™¤æ‰ï¼Œæ‰€ä»¥å‰©ä¸‹çš„æ˜¯

  - ```
    [GC Root]
       â†“
    [WindowManager] â†’ [Window]ï¼ˆå·²æ—  DecorView å¼•ç”¨ï¼‰
    ```

  - è¿™æ—¶ DecorView åŠå…¶å­ Viewï¼ˆåŒ…æ‹¬ addContentView æ·»åŠ çš„ Viewï¼‰å¦‚æœæ²¡æœ‰è¢«å…¶ä»–åœ°æ–¹å¼•ç”¨ï¼ŒGC å°±ä¼šå›æ”¶å®ƒä»¬ã€‚

- é‚£ä¸ºä»€ä¹ˆæ²¡æœ‰æŒ‰ç…§æˆ‘ä»¬æœŸæœ›çš„èµ°ï¼Ÿ

  - å¦‚æœ DecorView æˆ–å…¶å­ Viewï¼ˆæ¯”å¦‚ customerButtonï¼‰æœ‰â€œå¼‚æ­¥ä»»åŠ¡ã€å…¨å±€å›è°ƒã€é™æ€å˜é‡ã€çº¿ç¨‹ã€Handlerã€åŠ¨ç”»â€ç­‰å¼•ç”¨é“¾ï¼Œæˆ–è€…è¢«å…¶ä»–åœ°æ–¹ï¼ˆæ¯”å¦‚å…¨å±€å•ä¾‹ã€é™æ€é›†åˆï¼‰å¼•ç”¨ï¼ŒGC å°±æ— æ³•å›æ”¶å®ƒä»¬ã€‚

  - åªè¦æœ‰ä¸€æ¡é“¾èƒ½ä» GC Root èµ°åˆ° DecorView æˆ–å…¶å­ Viewï¼Œæ•´ä¸ªé“¾ä¸Šçš„å¯¹è±¡éƒ½ä¸ä¼šè¢«å›æ”¶ã€‚

### 4.3 è¿›ä¸€æ­¥æ€è€ƒ

æ‰€ä»¥ï¼Œè¿™è¿˜æ˜¯ä¸æ˜¯æ ¹æœ¬åŸå› ï¼Œæ ¹æœ¬åŸå› æ˜¯Activityfinishæ—¶ï¼Œå°è¯•é”€æ¯decorViewæ—¶ï¼Œå†…éƒ¨çš„ä½ æŸä¸ªViewå› ä¸ºè¢«æŸä¸ªå›è°ƒæ‰§è¡Œï¼Œå¯¼è‡´GCæ— æ³•å›æ”¶ã€‚å¯¼è‡´æš‚æ—¶æ€§çš„äº§ç”Ÿäº†å†…å­˜æ³„æ¼ã€‚

- çœ‹çœ‹å¼•ç”¨é“¾

  - ![image-20250801151255476](../../_pic_/image-20250801151255476.png)

- ä»–çš„æµç¨‹æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ

  - ```
    GC Root (ThreadLocal)
        â†“
    AnimationHandler (å…¨å±€åŠ¨ç”»è°ƒåº¦å™¨)
        â†“  
    ValueAnimator (åŠ¨ç”»å¯¹è±¡)
        â†“
    ViewPropertyAnimator$AnimatorEventListener (åŠ¨ç”»ç›‘å¬å™¨)
        â†“
    ViewPropertyAnimator (å±æ€§åŠ¨ç”»)
        â†“
    mView (ScrollImageView)
        â†“
    mContext (Activity)
    ```

- okï¼Œæˆ‘ä»¬æ¥ä»”ç»†çœ‹çœ‹ä»£ç æ„æˆï¼š

  - é—®é¢˜ä»£ç çš„æ„æˆï¼š

    - ```
      // ScrollImageView ä¸­
      private ValueAnimator mAnimator; // æˆå‘˜å˜é‡
      
      // åœ¨ startScrollAnimation() æ–¹æ³•ä¸­
      mAnimator = ValueAnimator.ofFloat(0, currentBitmap.getWidth());
      
      // ğŸš¨ é—®é¢˜æ ¸å¿ƒï¼šè¿™ä¸ª lambda è¡¨è¾¾å¼
      mAnimator.addUpdateListener(animation -> {
          mUnrolledWidth = (float) animation.getAnimatedValue(); // è®¿é—®å¤–éƒ¨ç±»å­—æ®µ
          invalidate(); // è°ƒç”¨å¤–éƒ¨ç±»æ–¹æ³•
      });
      
      mAnimator.start();
      ```

  - Lambda è¡¨è¾¾å¼çš„éšè—é™·é˜±ï¼Œå½“ä½ å†™è¿™ä¸ª lambda æ—¶

    - ```
      animation -> {
          mUnrolledWidth = (float) animation.getAnimatedValue(); // è®¿é—® this.mUnrolledWidth
          invalidate(); // è°ƒç”¨ this.invalidate()
      }
      ```

    - ç¼–è¯‘å™¨å®é™…ä¸Šä¼šç”Ÿæˆç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼š

    - ```
      // ç¼–è¯‘å™¨ç”Ÿæˆçš„åŒ¿åç±»ï¼ŒæŒæœ‰å¤–éƒ¨ç±»å¼•ç”¨
      new ValueAnimator.AnimatorUpdateListener() {
          @Override
          public void onAnimationUpdate(ValueAnimator animation) {
              ScrollImageView.this.mUnrolledWidth = (float) animation.getAnimatedValue();
              ScrollImageView.this.invalidate();
          }
      }
      ```

  - å¼ºå¼•ç”¨é“¾çš„å½¢æˆï¼š

    - ```
      [GC Root: ThreadLocal$ThreadLocalMap]
          â†“
      [AnimationHandler] (å…¨å±€åŠ¨ç”»è°ƒåº¦å™¨ï¼Œç®¡ç†æ‰€æœ‰åŠ¨ç”»)
          â†“
      [ArrayList: mAnimationCallbacks] (åŠ¨ç”»å›è°ƒåˆ—è¡¨)
          â†“
      [ValueAnimator: mAnimator] (ä½ çš„åŠ¨ç”»å¯¹è±¡)
          â†“
      [ArrayList: mUpdateListeners] (æ›´æ–°ç›‘å¬å™¨åˆ—è¡¨)
          â†“
      [AnimatorUpdateListener] (ä½ çš„ lambda ç”Ÿæˆçš„åŒ¿åç±»)
          â†“
      [ScrollImageView.this] (lambda æŒæœ‰çš„å¤–éƒ¨ç±»å¼•ç”¨)
          â†“
      [Context mContext] (Activity)
      ```

    

## 05. ä¿®å¤æ–¹æ¡ˆ

- ScrollImageViewä¸­æ·»åŠ 

  - ```
    @Override
       protected void onDetachedFromWindow() {
           super.onDetachedFromWindow();
           // ğŸ¯ æœ€ä¼˜é›…çš„ä¿®å¤ï¼šå–æ¶ˆåŠ¨ç”»ï¼Œæ–­å¼€æ³„æ¼é“¾è·¯
           if (mAnimator != null) {
               mAnimator.cancel();
           }
       }
    ```

    



## 06. éªŒè¯ä¸å›å½’

- ä¿®å¤åéªŒè¯æ–¹å¼ï¼ˆè‡ªåŠ¨åŒ–/æ‰‹åŠ¨/ä¸“é¡¹æµ‹è¯•ï¼‰
- å›å½’ç»“æœï¼ˆæ˜¯å¦å½»åº•è§£å†³ï¼Œæ˜¯å¦æœ‰å‰¯ä½œç”¨ï¼‰

## 07. ç»éªŒæ€»ç»“ä¸é¢„é˜²å»ºè®®

### 7.1 æŠ€æœ¯åŸç†

- ç›¸å…³å†…å­˜ç®¡ç†æœºåˆ¶ã€GCåŸç†ã€Androidç”Ÿå‘½å‘¨æœŸç­‰

### 7.2 é¢„é˜²æªæ–½

- ä»£ç è§„èŒƒã€å·¥å…·æ¥å…¥ã€reviewè¦ç‚¹ã€ä¸“é¡¹æµ‹è¯•å»ºè®®

### 7.3 å¸è½½è§„èŒƒ

- èµ„æºé‡Šæ”¾ã€è§£ç»‘ç›‘å¬ã€å¼±å¼•ç”¨ä½¿ç”¨ç­‰

### 7.4 è°ƒè¯•æŠ€å·§

- å¸¸ç”¨åˆ†æå‘½ä»¤ã€å·¥å…·ä½¿ç”¨å¿ƒå¾—ã€æ’æŸ¥æ€è·¯



![image-20250805164309910](../../_pic_/image-20250805164309910.png)

![image-20250805164304659](../../_pic_/image-20250805164304659.png)