[toc]

## 前言

> 学习要符合如下的标准化链条：了解概念->探究原理->深入思考->总结提炼->底层实现->延伸应用"

## 01.学习概述

- **学习主题**：
- **知识类型**：
  - [ ] **知识类型**：
    - [ ] ✅Android/ 
      - [ ] ✅01.基础组件
      - [ ] ✅02.IPC机制
      - [ ] ✅03.消息机制
      - [ ] ✅04.View原理
      - [ ] ✅05.事件分发机制
      - [ ] ✅06.Window
      - [ ] ✅07.复杂控件
      - [ ] ✅08.性能优化
      - [ ] ✅09.流行框架
      - [ ] ✅10.数据处理
      - [ ] ✅11.动画
      - [ ] ✅12.Groovy
    - [ ] ✅音视频开发/
      - [ ] ✅01.基础知识
      - [ ] ✅02.OpenGL渲染视频
      - [ ] ✅03.FFmpeg音视频解码
    - [ ] ✅ Java/
      - [ ] ✅01.基础知识
      - [ ] ✅02.Java设计思想
      - [ ] ✅03.集合框架
      - [ ] ✅04.异常处理
      - [ ] ✅05.多线程与并发编程
      - [ ] ✅06.JVM
    - [ ] ✅ Kotlin/
      - [ ] ✅01.基础语法
      - [ ] ✅02.高阶扩展
      - [ ] ✅03.协程和流
    - [ ] ✅ 故障分析与处理/
      - [ ] ✅01.基础知识
    - [ ] ✅ 自我管理/
      - [ ] ✅01.内观
    - [ ] ✅ 业务逻辑/
      - [ ] ✅01.启动
      - [ ] ✅02.首页
      - [ ] ✅03.巡店
      - [ ] ✅04.云值守
      - [ ] ✅05.消息中心
      - [ ] ✅06.智控平台
- **学习来源**：
- **重要程度**：⭐⭐⭐⭐⭐
- **学习日期**：2025.
- **记录人**：@panruiqi

### 1.1 学习目标

- 了解概念->探究原理->深入思考->总结提炼->底层实现->延伸应用"

### 1.2 前置知识

- [ ] 

## 02.核心概念

### 2.1 业务痛点与需求




### 2.2 解决方案



### 2.3 基本特性



## 03.代码执行过程

### 3.0 引子_实际对应的页

先来过一下这里面的主要的页

- 首先是首页中的巡店记录的子条目
  - <img src="../../_pic_/image-20250918185717337.png" alt="image-20250918185717337" style="zoom:67%;" />
- 点进去后是这个页：CruiseShopHistoryActivity
  - <img src="../../_pic_/image-20250918185756998.png" alt="image-20250918185756998" style="zoom:67%;" />
- 点击内部的子条目，进入到H5页，显示巡店详情
  - <img src="../../_pic_/image-20250918185849704.png" alt="image-20250918185849704" style="zoom:67%;" />
- 点击筛选按钮拉出CruiseHisFilterFragment巡店记录筛选Fragment
  - <img src="../../_pic_/image-20250918185920333.png" alt="image-20250918185920333" style="zoom:67%;" />
- 点击筛选中的巡店模板，跳转到新的点检项常用模板页。
  - ![image-20250918190004744](../../_pic_/image-20250918190004744.png)

好，我们先来看看进入他的流程，他有多种进入方式

首先是首页的进入方式

- 

### 3.1 进入方式分析

- 三种不同的进入方式，决定不同的初始化逻辑
  - ![image-20250918190636012](../../_pic_/image-20250918190636012.png)

### 3.2 初始化逻辑

首先是布局初始化

- 埋点，绑定日历视图，动态设置筛选fragment的宽度为屏幕宽度，加载背景设置为白色；这里还有一个fromType的解析，解析INTENT_TAG_TYPE，默认为0，其对应上面的三种不同的进入方式。
  - ![image-20250918191320906](../../_pic_/image-20250918191320906.png)

- 来看一下筛选fragment的参数设置
  - 首先是创建 DisplayMetrics对象，并通过 windowManager.defaultDisplay.getMetrics() 传递DisplayMetrics对象获取当前屏幕的尺寸信息。提取屏幕宽度像素值 widthPixels。
  - 获取筛选fragment容器(problemCreateFilterLayout)的布局参数，设置宽度为屏幕宽度并重新应用布局参数
  - ![image-20250918191904908](../../_pic_/image-20250918191904908.png)

然后是UI模式设置

- 非门店进入，显示完整的Tab切换界面，如果是门店首页进入，只保留筛选功能，其他Tab隐藏。
  - ![image-20250918192218109](../../_pic_/image-20250918192218109.png)
  - 对应的就是这个
  - ![image-20250918192323680](../../_pic_/image-20250918192323680.png)
  - 和这个
  - ![image-20250918192422020](../../_pic_/image-20250918192422020.png)

然后是解析Intent参数，处理巡店类型。

- 分为以下几个部分
  - 解析巡店方式，分为现场/远程/门店自检，默认值为-1表示未指定类型，通常从首页进入时会是这个值
  - 获取H5跳转过来时候的 门店id、进行中、开始、结束时间；巡店状态：-1:显示全部巡店记录  0：只显示进行中的巡店  1：只显示已完成的巡店； fromType不是门店首页，那么会标记来自H5跳转；赋值预选门店，格式为"S_" + 门店ID
  - 创建CruiseShopPresenter，并设置其类型，现场巡店，远程巡店，门店自检。
  - ![image-20250918193915870](../../_pic_/image-20250918193915870.png)

然后是巡店的RecyclerView和adapter的初始化

- 先创建LiveListDividerItemDecoration: 自定义分割线，高度10dp，背景色为主题背景色；然后设置垂直布局，分割线，告知其尺寸固定，以及默认的增删动画。
  - ![image-20250918194213843](../../_pic_/image-20250918194213843.png)
- 然后是adapter的初始化：设置ItemClickCallback，内部有
  - 用户点击
    - ![image-20250918195323987](../../_pic_/image-20250918195323987.png)
  - 无效点击
    - ![image-20250918195431592](../../_pic_/image-20250918195431592.png)
  - 条目点击
  - 首先根据当前视图模式记录不同的埋点，分为：列表模式下：我管辖的，我的巡店；和日历模式下
    - ![image-20250918195507711](../../_pic_/image-20250918195507711.png)
  - 多选模式处理，现在好像不开多选模式了，忽略
    - ![image-20250918195659794](../../_pic_/image-20250918195659794.png)
  - ok，不是多选模式
  - 首先是进行中的巡店：
    - 权限验证：创建人或协同人员才能继续巡店；
    - 获取门店名称用于水印
    - 根据巡店类型设置不同的处理方式： 
    -  0, 10, 15 -> {  *// 现场、计划巡店-现场、巡检计划-现场*      这些对应现场巡店
    - 1, 11 -> {    *// 远程、计划巡店-远程*         对应远程巡店  
    -  12, 17 -> {   *// 门店自检、计划巡店-门店自检*       跳转到H5门店自检页面
    - ![image-20250918195949333](../../_pic_/image-20250918195949333.png)
    - ![image-20250918200145067](../../_pic_/image-20250918200145067.png)
    - 然后最后设置门店信息并获取门店管理员信息
    - ![image-20250918200243353](../../_pic_/image-20250918200243353.png)
  - 好，接着是已完成/待审核的巡店
    - 获取是否已审批
    - 根据已审批，未审批设置bundle参数
    - 跳转到巡店报告H5页面
    - ![image-20250918200418452](../../_pic_/image-20250918200418452.png)
  - 然后是其他状态
    - ![image-20250918200553191](../../_pic_/image-20250918200553191.png)
  - 待修改，跳转到提交页面进行修改
    - ![image-20250918200635337](../../_pic_/image-20250918200635337.png)
  - 待提交：跳转到提交页面
    - ![image-20250918200718452](../../_pic_/image-20250918200718452.png)

- 设置adapter
  - ![image-20250918200815442](../../_pic_/image-20250918200815442.png)

然后是日历的RecyclerView和adapter的初始化 

- 其实就是日历模式下的巡店记录条目项
  - <img src="../../_pic_/image-20250918200837209.png" alt="image-20250918200837209" />
  - <img src="../../_pic_/image-20250918200932340.png" alt="image-20250918200932340" style="zoom:67%;" />

然后是日历模式的一些配置

- ![image-20250918201229114](../../_pic_/image-20250918201229114.png)

### 3.3 数据初始化

不行，初始化逻辑太多了，数据初始化要拿出来说，承接上面的，紧接着就到了restoreManagerCheck等数据初始化阶段

首先是restoreManagerCheck

- 如果是来自于管理页，那么从EasyDataStore中取出数据，restore
  - ![image-20250918201315906](../../_pic_/image-20250918201315906.png)

然后是initFilter，这是整个筛选系统的核心初始化方法，他用于加载筛选配置、设置默认值、创建筛选Fragment

- 首先是筛选配置文件加载

  - 从assets文件夹加载筛选配置JSON
  - 进行国际化处理
  - 获取筛选类别标题数组
  - ![image-20250918202926730](../../_pic_/image-20250918202926730.png)
  - 配置JSON是这样的
  - <img src="../../_pic_/image-20250918203022098.png" alt="image-20250918203022098" style="zoom:67%;" />
  - 解析为这个
  - <img src="../../_pic_/image-20250918203103435.png" alt="image-20250918203103435" style="zoom:67%;" />
  - ![image-20250918203148114](../../_pic_/image-20250918203148114.png)

  > 有点多，举例说明吧
  >
  > 这是巡店状态
  >
  > - ![image-20250918203316254](../../_pic_/image-20250918203316254.png)
  >
  > 解析为结构体后，最后对应的这个
  >
  > - ![image-20250918203339036](../../_pic_/image-20250918203339036.png)
  - 解析巡店方式配置组对应这个
  - <img src="../../_pic_/image-20250918203442811.png" alt="image-20250918203442811" style="zoom:67%;" />

- 是否添加评论"筛选项 审批状态初始化

  - 如果是1，就是筛选"已添加评论"的记录，那么全部为false。已添加评论为true，未添加评论为false
  - ![image-20250918203542758](../../_pic_/image-20250918203542758.png)
  - 对应这个，第一个是标题项，剩下三个是评论状态
  - ![image-20250918204058086](../../_pic_/image-20250918204058086.png)

  > 我们可以看到这里是硬编码，其对应如下
  >
  > | 索引        | ID   | 筛选项名称           | 说明                   |
  > | :---------- | :--- | :------------------- | :--------------------- |
  > | allList[0]  | 0    | 创建时间             | 时间范围筛选           |
  > | allList[1]  | 1    | 巡店人               | 执行巡店的人员         |
  > | allList[2]  | 2    | 范围(门店或组织架构) | 巡店的门店范围         |
  > | allList[3]  | 3    | 巡店方式             | 现场/远程/门店自检     |
  > | allList[4]  | 4    | 巡店状态             | 进行中/已完成/待审核等 |
  > | allList[5]  | 5    | 当前审核人           | 审核人员筛选           |
  > | allList[6]  | 6    | 巡店模板             | 使用的巡店模板         |
  > | allList[7]  | 7    | 抄送                 | 是否抄送相关人员       |
  > | allList[8]  | 8    | 提交地点             | 在店内/店外提交        |
  > | allList[9]  | 9    | 门店状态             | 门店的营业状态         |
  > | allList[10] | 10   | 是否添加评论         | 有无评论的记录         |
  > | allList[11] | 11   | 计划巡店             | 计划巡店任务           |

- 然后是筛选数据的深度拷贝，为不同的筛选Fragment创建独立的数据副本，避免多个Fragment之间的状态互相影响

  - ![image-20250918204446351](../../_pic_/image-20250918204446351.png)

- 管理页则回复上一次的筛选数据，这个数据是从上面的EasyData中拿到的

  - ![image-20250918204513616](../../_pic_/image-20250918204513616.png)

- 然后是创建三种类型的筛选页，默认是我的巡店筛选

  - <img src="../../_pic_/image-20250918204827125.png" alt="image-20250918204827125" style="zoom:67%;" />
  - <img src="../../_pic_/image-20250918204834094.png" alt="image-20250918204834094" style="zoom:67%;" />
  - 怎么确定他们是筛选页？添加到R.id.problem_create_filter_layout中，我们上面有这个位置设置其布局参数的逻辑讲解。
    - ![image-20250918204957231](../../_pic_/image-20250918204957231.png)
  - 看看这里的三个方法
    - refreshFilterParam(filterFragmentManager)刷新筛选数据，用Fragment中的数据填充当前的筛选数据
    - <img src="../../_pic_/image-20250918205112789.png" alt="image-20250918205112789" style="zoom:67%;" />
    - getHistoryList(true)：重新进行网络请求获取巡店记录列表，然后刷新列表
    - ![image-20250918205424404](../../_pic_/image-20250918205424404.png)
    - 最后是toggle切换筛选框状态，打开或关闭，上面打开，那么commit后就关闭他。
    - ![image-20250918205604244](../../_pic_/image-20250918205604244.png)

- 最后是外部跳转参数处理逻辑，就是设置预选门店

  - ![image-20250918205832291](../../_pic_/image-20250918205832291.png)

最后是列表模式和日历模式的处理

- 这是整体
  - ![image-20250918210234002](../../_pic_/image-20250918210234002.png)
- 列表模式-我管辖的巡店
  - 列表模式，显示tablayout，隐藏日历
  - 我管理的巡店：特殊处理，配置请求参数为近三个月数据，然后通过getHistoryList发起网络请求，加载巡店记录；然后使用filterFragmentManager（管理者专用筛选）替换到视图上；然后高亮"我管辖的"Tab，置灰"我的巡店"Tab。
  - ![image-20250918210436528](../../_pic_/image-20250918210436528.png)

- 剩下的两个：我的巡店和日历模式不想多说

### 3.4 addEvents事件监听

没必要多说啥，就是点击切换相关的视图，同时布置埋点。

### 3.5 进一步思考



### 3.6 总结一下，整个数据的流转过程是什么样的?



## 04.底层原理



## 05.深度思考

### 5.1 关键问题探究



### 5.2 设计对比



## 06.实践验证

### 6.1 行为验证代码



### 6.2 性能测试





## 07.应用场景

### 7.1 最佳实践



### 7.2 使用禁忌





## 08.总结提炼

### 8.1 核心收获



### 8.2 知识图谱



### 8.3 延伸思考





## 09.参考资料

1. []()
2. []()
3. []()

## 其他介绍

### 01.关于我的博客

- csdn：http://my.csdn.net/qq_35829566

- 掘金：https://juejin.im/user/499639464759898

- github：https://github.com/jjjjjjava

- 邮箱：[934137388@qq.com]

