[toc]

## 01.é—®é¢˜è®°å½•

- **[ä¸¥é‡çº§åˆ«] **
  - [ ] âš ï¸ é˜»æ–­ (Blocker)ï¼šç³»ç»Ÿå´©æºƒã€æ ¸å¿ƒåŠŸèƒ½å®Œå…¨ä¸å¯ç”¨
  - [x] ğŸ”´ ä¸¥é‡ (Critical)ï¼šæ ¸å¿ƒåŠŸèƒ½å—æŸï¼Œæ— å¯ç”¨æ›¿ä»£æ–¹æ¡ˆ
  - [ ] ğŸŸ  é«˜ (High)ï¼šä¸»è¦åŠŸèƒ½å—å½±å“ï¼Œä½†æœ‰ä¸´æ—¶è§£å†³æ–¹æ¡ˆ
  - [ ] ğŸŸ¡ ä¸­ (Medium)ï¼šæ¬¡è¦åŠŸèƒ½é—®é¢˜ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ
  - [ ] ğŸŸ¢ ä½ (Low)ï¼šç•Œé¢é—®é¢˜æˆ–è½»å¾®å¼‚å¸¸ï¼Œä¸å½±å“åŠŸèƒ½
- **é—®é¢˜ç®€è¦æè¿°**
  - **Bug ID**ï¼š`BUG-20240609-001`  
  - **å‘ç°æ—¥æœŸ**ï¼š2025-06-09  
  - **å½±å“ç‰ˆæœ¬**ï¼šv0.5.0 (build 050)  
  - **æäº¤äºº**ï¼š@panruiqi
  - **çŠ¶æ€**ï¼šâŒ› ä¿®å¤ä¸­ / âœ… å·²è§£å†³ / âŒ æ— æ³•å¤ç°  

- **é—®é¢˜ç°è±¡**
  - [ ] å€˜è‹¥åº”ç”¨æœªè¢«æˆäºˆæƒé™ï¼Œé‚£ä¹ˆOTAä¸‹è½½å®Œåº”ç”¨apkåï¼Œéœ€è¦è·³è½¬åˆ°ç³»ç»Ÿè®¾ç½®æƒé™çš„ä½ç½®ï¼Œè®¾ç½®å®Œæˆè¿”å›åï¼Œå®‰è£…å¼¹çª—æ¶ˆå¤±ï¼Œapkå®‰è£…åŒ…è¢«åˆ é™¤
- **ç¯å¢ƒç‰¹å¾**
  - è®¾å¤‡å‹å·: rk3562_t
  - OSç‰ˆæœ¬: Android 13 (API 34)
  - ç½‘ç»œç¯å¢ƒ: å…¬å¸å†…ç½‘
  - ç”¨æˆ·è´¦æˆ·: primary_user (ID:0)
  - è§¦å‘æ—¶æœº: ç³»ç»Ÿå¯åŠ¨æ—¶

## 02.é—®é¢˜åˆ†æ

### 2.1 æ—¥å¿—åˆ†æ

- ```
  W  (ApkDownloadManager.kt:202) installApk() æ²¡æœ‰å®‰è£…æœªçŸ¥æ¥æºåº”ç”¨çš„æƒé™ï¼Œé€šçŸ¥éœ€è¦æƒé™
  2025-06-09 10:15:23.788 19656-19656 (LogManager.kt:156) w   com.ovopark.cloudpos   
  
  W  (OtaUpdateDialog.kt:211) onNeedInstallPermission$lambda$4() éœ€è¦å®‰è£…æƒé™ï¼Œå°è¯•è¯·æ±‚æƒé™
  2025-06-09 10:15:23.793 19656-19656 Compatibil...geReporter com.ovopark.cloudpos  
  
  D  Compat change id reported: 147798919; UID 10097; state: ENABLED
  2025-06-09 10:15:23.797 19656-19656 (LogManager.kt:149) 
  
  I  (ApkDownloadManager.kt:251) cancelDownload() æ¸…é™¤apkä¸‹è½½çš„ä»»åŠ¡ï¼Œå…·ä½“æ˜¯å¦ä¸‹è½½å®Œæˆå‚è€ƒä¹‹å‰æ—¥å¿—
  ```

### 2.2 æ ¹æœ¬åŸå› æ¨ç†

- ä»æ—¥å¿—æ¥çœ‹ï¼Œé‡åˆ°çš„é—®é¢˜æ˜¯ï¼š

  1. ApkDownloadManageræ£€æµ‹åˆ°æ²¡æœ‰å®‰è£…æœªçŸ¥æ¥æºåº”ç”¨çš„æƒé™

  1. è°ƒç”¨äº†onNeedInstallPermissionå›è°ƒ

  1. åœ¨OtaUpdateDialogä¸­å°è¯•è¯·æ±‚æƒé™

  1. ä½†æ˜¯çœ‹èµ·æ¥æƒé™è¯·æ±‚æ²¡æœ‰æ­£ç¡®å¯åŠ¨ï¼Œæœ€åè¿˜è°ƒç”¨äº†cancelDownload()

- é—®é¢˜å¯èƒ½æ˜¯ï¼š

  1. Contextä¸æ˜¯MainActivityå®ä¾‹ï¼Œæ‰€ä»¥æ— æ³•è°ƒç”¨requestInstallPermission()

  1. æˆ–è€…MainActivityçš„requestInstallPermission()æ–¹æ³•æ²¡æœ‰æ­£ç¡®å·¥ä½œ

  è®©æˆ‘æ£€æŸ¥ä¸€ä¸‹MainActivityä¸­çš„requestInstallPermission()æ–¹æ³•ï¼Œä»¥åŠç¡®è®¤OtaUpdateDialogä¸­çš„contextç±»å‹ã€‚

## 03.ä»£ç åˆ†æ

### 3.1 å…³è”ä»£ç è·¯å¾„

- ```
  // å°è¯•è°ƒç”¨MainActivityçš„æƒé™è¯·æ±‚æ–¹æ³•
  val activity = context
  if (activity is com.ovopark.cloudpos.ui.main.MainActivity) {
  activity.requestInstallPermission()
  
  ```

- åº”å½“æ˜¯ä¸Šä¸‹æ–‡ä¸æ˜¯MainActivityã€‚å¯¼è‡´è°ƒç”¨å¤±è´¥ã€‚
- é‚£ä¹ˆè¯·é—®ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡ï¼Ÿè¿™ä¸ªç©¶ç«Ÿåšäº†ä»€ä¹ˆï¼Ÿ



### 3.2 å¯ç–‘ä¿®æ”¹ç‚¹

## 04.å¤ç°æ­¥éª¤



## 05.è§£å†³æ–¹æ¡ˆå°è¯•

### 5.1 ç¬¬ä¸€æ¬¡è§£å†³æ–¹æ¡ˆ

- åˆ†æï¼š

  - åº”å½“æ˜¯ä¸Šä¸‹æ–‡ä¸æ˜¯MainActivityã€‚å¯¼è‡´è°ƒç”¨å¤±è´¥ã€‚

- è§£å†³æ–¹æ¡ˆï¼š

  - ç›´æ¥ä½¿ç”¨Intentè°ƒç”¨ï¼Œè€Œéé€šè¿‡contextè°ƒç”¨activityå†…éƒ¨ç›¸å…³æ–¹æ³•ï¼Œé¿å…contextä¸åŒ¹é…çš„é—®é¢˜

  - ```
     // å°è¯•ç›´æ¥è¯·æ±‚å®‰è£…æƒé™
                    try {
                        if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.O) {
                            val intent = android.content.Intent(android.provider.Settings.ACTION_MANAGE_UNKNOWN_APP_SOURCES).apply {
                                data = android.net.Uri.parse("package:${context.packageName}")
                                flags = android.content.Intent.FLAG_ACTIVITY_NEW_TASK
                            }
                            context.startActivity(intent)
                            LogManager.i("æˆåŠŸå¯åŠ¨å®‰è£…æƒé™è®¾ç½®é¡µé¢")
                        } else {
                            LogManager.d("Android 8.0ä»¥ä¸‹æ— éœ€å®‰è£…æƒé™")
                        }
                    } catch (e: Exception) {
                        LogManager.e("æ— æ³•å¯åŠ¨å®‰è£…æƒé™è®¾ç½®é¡µé¢: ${e.message}", e)
                        android.widget.Toast.makeText(
                            context, 
                            "æ— æ³•æ‰“å¼€æƒé™è®¾ç½®ï¼Œè¯·æ‰‹åŠ¨åˆ°è®¾ç½®ä¸­å¼€å¯å®‰è£…æœªçŸ¥åº”ç”¨æƒé™", 
                            android.widget.Toast.LENGTH_LONG
                        ).show()
    ```

- ç»“æœï¼š

  - ç°åœ¨åˆ°äº†æˆäºˆæƒé™çš„é¡µé¢ï¼Œä½†æ˜¯æˆäºˆåå›é€€åˆ°å½“å‰MainActivityä¸­ï¼Œæ²¡æ³•å®‰è£…åº”ç”¨ï¼Œæ˜¾ç¤ºå¦‚ä¸‹ï¼š

  - ```
    I  (OtaUpdateDialog.kt:226) onNeedInstallPermission$lambda$5() æˆåŠŸå¯åŠ¨å®‰è£…æƒé™è®¾ç½®é¡µé¢
    2025-06-09 10:32:02.807 20658-20658 (LogManager.kt:149)
    
    I  (ApkDownloadManager.kt:251) cancelDownload() æ¸…é™¤apkä¸‹è½½çš„ä»»åŠ¡ï¼Œå…·ä½“æ˜¯å¦ä¸‹è½½å®Œæˆå‚è€ƒä¹‹å‰æ—¥å¿—
    ```

### 5.2 ç¬¬äºŒæ¬¡è§£å†³æ–¹æ¡ˆ

- åˆ†æï¼š

  - å½“æˆ‘å»è®¾ç½®é¡µé¢æˆäºˆæƒé™æ—¶ï¼ŒOtaUpdateDialogè°ƒç”¨äº†dismiss()ï¼Œè¿™å¯¼è‡´ä¸‹è½½ä»»åŠ¡è¢«å–æ¶ˆäº†ã€‚ç”¨æˆ·æˆäºˆæƒé™è¿”å›åï¼Œæ²¡æœ‰æœºåˆ¶æ¥é‡æ–°å¯åŠ¨å®‰è£…è¿‡ç¨‹ã€‚

- è§£å†³æ–¹æ¡ˆï¼š

  - ä¸è¦åœ¨æƒé™è¯·æ±‚æ—¶ç«‹å³dismisså¯¹è¯æ¡†

  - åœ¨MainActivityä¸­ç›‘å¬ä»è®¾ç½®è¿”å›çš„äº‹ä»¶

  - å½“æƒé™æˆäºˆåé‡æ–°å°è¯•å®‰è£…

  - ```
    
        /**
         * å¯åŠ¨æƒé™æ£€æŸ¥å®šæ—¶å™¨
         * å®šæœŸæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æˆäºˆå®‰è£…æƒé™
         */
        private fun startPermissionCheckTimer() {
            LogManager.i("å¯åŠ¨æƒé™æ£€æŸ¥å®šæ—¶å™¨")
            
            permissionCheckTimer?.cancel()
            permissionCheckTimer = object : android.os.CountDownTimer(60000, 2000) { // 60ç§’è¶…æ—¶ï¼Œæ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
                override fun onTick(millisUntilFinished: Long) {
                    // æ£€æŸ¥æƒé™çŠ¶æ€
                    if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.O) {
                        if (context.packageManager.canRequestPackageInstalls()) {
                            LogManager.i("æ£€æµ‹åˆ°ç”¨æˆ·å·²æˆäºˆå®‰è£…æƒé™ï¼Œç»§ç»­å®‰è£…")
                            cancel()
                            
                            // æ›´æ–°UI
                            updatingBinding?.let { binding ->
                                binding.tvProgress.text = "æ­£åœ¨å®‰è£…..."
                                binding.progressUpdate.progress = 100
                            }
                            
                            // ç»§ç»­å®‰è£…
                            pendingApkFile?.let { apkFile ->
                                try {
                                    downloadManager?.installApk(apkFile)
                                    LogManager.i("é‡æ–°å°è¯•å®‰è£…APK")
                                } catch (e: Exception) {
                                    LogManager.e("é‡æ–°å®‰è£…APKå¤±è´¥: ${e.message}", e)
                                    android.widget.Toast.makeText(context, "å®‰è£…å¤±è´¥: ${e.message}", android.widget.Toast.LENGTH_LONG).show()
                                    dismiss()
                                }
                            } ?: run {
                                LogManager.w("æ²¡æœ‰å¾…å®‰è£…çš„APKæ–‡ä»¶")
                                dismiss()
                            }
                        }
                    }
                }
                
                override fun onFinish() {
                    LogManager.w("æƒé™æ£€æŸ¥è¶…æ—¶ï¼Œç”¨æˆ·å¯èƒ½æœªæˆäºˆæƒé™")
                    updatingBinding?.let { binding ->
                        binding.tvProgress.text = "æƒé™è¯·æ±‚è¶…æ—¶"
                    }
                    android.widget.Toast.makeText(context, "æƒé™è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡æ–°å°è¯•æ›´æ–°", android.widget.Toast.LENGTH_LONG).show()
                    
                    // å»¶è¿Ÿå…³é—­å¯¹è¯æ¡†
                    progressHandler?.postDelayed({
                        dismiss()
                    }, 2000)
                }
            }.start()
        }
    ```

- ç»“æœï¼š

  - å¡åœ¨ä¸‹é¢çš„ä½ç½®

  - ```
    W Background activity start [callingPackage: com.ovopark.cloudpos; callingUid: 10101; appSwitchState: 2; isCallingUidForeground: false; callingUidHasAnyVisibleWindow: false; callingUidProcState: LAST_ACTIVITY; isCallingUidPersistentSystemProcess: false; realCallingUid: 10101; isRealCallingUidForeground: false; realCallingUidHasAnyVisibleWindow: false; realCallingUidProcState: LAST_ACTIVITY; isRealCallingUidPersistentSystemProcess: false; originatingPendingIntent: null; allowBackgroundActivityStart: false; intent: Intent { act=android.intent.action.VIEW dat=content://com.ovopark.cloudpos.fileprovider/... typ=application/vnd.android.package-archive flg=0x10000001 cmp=com.android.packageinstaller/.InstallStart }; callerApp: ProcessRecord{f4f7ef9 21113:com.ovopark.cloudpos/u0a101}; inVisibleTask: false]
    2025-06-09 10:38:39.533 21113-21113 (LogManager.kt:149) 
    
    
    i   com.ovopark.cloudpos                 I  (ApkDownloadManager.kt:227) installApk() å¯åŠ¨APKå®‰è£…
    2025-06-09 10:38:39.545 21113-21113 (LogManager.kt:149) i   com.ovopark.cloudpos                 
    
    I  (OtaUpdateDialog.kt:344) onTick() é‡æ–°å°è¯•å®‰è£…APK
    ```

### 5.3 ç¬¬ä¸‰æ¬¡è§£å†³æ–¹æ¡ˆ

- åˆ†æï¼š

  - ä»æ—¥å¿—å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªBackground activity startè­¦å‘Šã€‚è¿™æ˜¯å› ä¸ºå½“ç”¨æˆ·ä»è®¾ç½®é¡µé¢è¿”å›æ—¶ï¼Œåº”ç”¨å¯èƒ½å·²ç»è¿›å…¥åå°çŠ¶æ€ï¼ŒAndroidç³»ç»Ÿé™åˆ¶äº†åå°åº”ç”¨å¯åŠ¨æ–°çš„Activityï¼ˆåŒ…æ‹¬å®‰è£…ç•Œé¢ï¼‰ã€‚

- è§£å†³æ–¹æ¡ˆï¼š

  - æˆ‘éœ€è¦ä¿®æ”¹å®‰è£…é€»è¾‘ï¼Œç¡®ä¿åœ¨å‰å°çŠ¶æ€ä¸‹å¯åŠ¨å®‰è£…ï¼Œæˆ–è€…å°†åº”ç”¨å¸¦å›å‰å°ã€‚

  - ```
     // å…ˆç¡®ä¿åº”ç”¨å›åˆ°å‰å°ï¼Œç„¶åå¯åŠ¨å®‰è£…
                            try {
                                // åˆ›å»ºä¸€ä¸ªIntentæ¥å°†åº”ç”¨å¸¦å›å‰å°
                                val bringToForegroundIntent = android.content.Intent(context, context::class.java).apply {
                                    flags = android.content.Intent.FLAG_ACTIVITY_REORDER_TO_FRONT or android.content.Intent.FLAG_ACTIVITY_NEW_TASK
                                }
                                context.startActivity(bringToForegroundIntent)
                                
                                // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿åº”ç”¨å›åˆ°å‰å°åå†å¯åŠ¨å®‰è£…
                                progressHandler?.postDelayed({
                                    pendingApkFile?.let { apkFile ->
                                        try {
                                            downloadManager?.installApk(apkFile)
                                            LogManager.i("é‡æ–°å°è¯•å®‰è£…APK")
                                        } catch (e: Exception) {
                                            LogManager.e("é‡æ–°å®‰è£…APKå¤±è´¥: ${e.message}", e)
                                            android.widget.Toast.makeText(context, "å®‰è£…å¤±è´¥: ${e.message}", android.widget.Toast.LENGTH_LONG).show()
                                            dismiss()
                                        }
                                    } ?: run {
                                        LogManager.w("æ²¡æœ‰å¾…å®‰è£…çš„APKæ–‡ä»¶")
                                        dismiss()
                                    }
                                }, 500) // å»¶è¿Ÿ500ms
                                
                            } catch (e: Exception) {
                                LogManager.e("æ— æ³•å°†åº”ç”¨å¸¦å›å‰å°: ${e.message}", e)
                                // å¦‚æœæ— æ³•å¸¦å›å‰å°ï¼Œç›´æ¥å°è¯•å®‰è£…
                                pendingApkFile?.let { apkFile ->
                                    try {
                                        downloadManager?.installApk(apkFile)
                                        LogManager.i("ç›´æ¥å°è¯•å®‰è£…APK")
                                    } catch (e2: Exception) {
                                        LogManager.e("ç›´æ¥å®‰è£…APKå¤±è´¥: ${e2.message}", e2)
                                        android.widget.Toast.makeText(context, "å®‰è£…å¤±è´¥: ${e2.message}", android.widget.Toast.LENGTH_LONG).show()
                                        dismiss()
                                    }
                                }
    ```

- ç»“æœï¼š

  - å¡åœ¨ä¸‹é¢çš„ä½ç½®

  - ```
            I  (OtaUpdateDialog.kt:347) onTick() å°è¯•å°†åº”ç”¨å¸¦å›å‰å°
    2025-06-09 10:41:39.352 21424-21424 (LogManager.kt:149) i   com.ovopark.cloudpos                 I  (ApkDownloadManager.kt:197) installApk() å¼€å§‹å®‰è£…APK: /storage/emulated/0/Android/data/com.ovopark.cloudpos/files/Download/apk_download/CloudPos_0.4.0.apk
    2025-06-09 10:41:39.371   477-6116  ActivityTaskManager     system_server                        I  START u0 {act=android.intent.action.VIEW dat=content://com.ovopark.cloudpos.fileprovider/... typ=application/vnd.android.package-archive flg=0x14000001 cmp=com.android.packageinstaller/.InstallStart} from uid 10101
    2025-06-09 10:41:39.373   477-6116  ActivityTaskManager     system_server                        W  Background activity start [callingPackage: com.ovopark.cloudpos; callingUid: 10101; appSwitchState: 2; isCallingUidForeground: false; callingUidHasAnyVisibleWindow: false; callingUidProcState: LAST_ACTIVITY; isCallingUidPersistentSystemProcess: false; realCallingUid: 10101; isRealCallingUidForeground: false; realCallingUidHasAnyVisibleWindow: false; realCallingUidProcState: LAST_ACTIVITY; isRealCallingUidPersistentSystemProcess: false; originatingPendingIntent: null; allowBackgroundActivityStart: false; intent: Intent { act=android.intent.action.VIEW dat=content://com.ovopark.cloudpos.fileprovider/... typ=application/vnd.android.package-archive flg=0x14000001 cmp=com.android.packageinstaller/.InstallStart }; callerApp: ProcessRecord{e7ea9c9 21424:com.ovopark.cloudpos/u0a101}; inVisibleTask: false]
    2025-06-09 10:41:39.376 21424-21424 (LogManager.kt:149) i   com.ovopark.cloudpos                 I  (ApkDownloadManager.kt:227) installApk() å¯åŠ¨APKå®‰è£…
    2025-06-09 10:41:39.379 21424-21424 (LogManager.kt:149) i   com.ovopark.cloudpos                 I  (OtaUpdateDialog.kt:354) onTick$lambda$4() é‡æ–°å°è¯•å®‰è£…APK
    2025-06-09 10:41:39.663 21424-21451 OpenGLRenderer          com.ovopark.cloudpos                 E  Unable to match the desired swap behavior.
    2025-06-09 10:41:39.692 21424-21424 UI                      com.ovopark.cloudpos                 D  (BaseVbVmActivity.kt:71) onStart() MainActivity onStart()
    2025-06-09 10:41:39.698 21424-21424 (LogManager.kt:144) d   com.ovopark.cloudpos                 D  (ScanInputManager.kt:102) resetScanState() æ‰«ç çŠ¶æ€å·²é‡ç½®ï¼Œæ–°ä¼šè¯å¼€å§‹æ—¶é—´: 1749436899697
    2025-06-09 10:41:39.699 21424-21424 (LogManager.kt:144) d   com.ovopark.cloudpos                 D  
    ```

### 5.4 ç¬¬å››æ¬¡è§£å†³æ–¹æ¡ˆ

- åˆ†æï¼š

  - ä»æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶æˆ‘ä»¬å°è¯•å°†åº”ç”¨å¸¦å›å‰å°ï¼Œä½†ç³»ç»Ÿä»ç„¶æŠ¥å‘Š"Background activity start"è­¦å‘Šã€‚è¿™è¯´æ˜æˆ‘ä»¬çš„å‰å°åˆ‡æ¢ç­–ç•¥æ²¡æœ‰å®Œå…¨è§£å†³é—®é¢˜ã€‚

  - åˆ†æä¸€ä¸‹é—®é¢˜ï¼š

    1. ç”¨æˆ·ä»è®¾ç½®é¡µé¢è¿”å›åï¼Œåº”ç”¨ç¡®å®å›åˆ°äº†å‰å°ï¼ˆå¯ä»¥çœ‹åˆ°onStart()å’ŒonResume()è¢«è°ƒç”¨ï¼‰

    1. ä½†æ˜¯å®‰è£…Intentä»ç„¶è¢«è§†ä¸ºåå°å¯åŠ¨

  - è¿™å¯èƒ½æ˜¯å› ä¸ºï¼š

    1. å»¶è¿Ÿæ—¶é—´ä¸å¤Ÿé•¿ï¼Œåº”ç”¨è¿˜æ²¡æœ‰å®Œå…¨å›åˆ°å‰å°çŠ¶æ€

    1. æˆ–è€…éœ€è¦ç­‰å¾…Activityå®Œå…¨Resumeåå†å¯åŠ¨å®‰è£…

    1. æˆ–è€…Androidç³»ç»Ÿå¯¹å®‰è£…Intentæœ‰ç‰¹æ®Šçš„é™åˆ¶

- è§£å†³æ–¹æ³•ï¼š

  - å°è¯•ä¸€ä¸ªä¸åŒçš„æ–¹æ³•ï¼š

    1. ä¸ä¾èµ–å®šæ—¶å™¨æ£€æŸ¥æƒé™

    1. è€Œæ˜¯åœ¨MainActivityçš„onResume()ä¸­æ£€æŸ¥æ˜¯å¦æœ‰å¾…å®‰è£…çš„APK

    1. å¦‚æœæœ‰ï¼Œå°±åœ¨Activityå®Œå…¨æ¢å¤åå¯åŠ¨å®‰è£…

  - è¿™æ ·å¯ä»¥ç¡®ä¿å®‰è£…æ˜¯åœ¨å‰å°Activityä¸­å¯åŠ¨çš„ã€‚

  - ```
     // å°†APKæ–‡ä»¶è·¯å¾„è®¾ç½®åˆ°MainActivity
                    pendingApkFile?.let { apkFile ->
                        val activity = context
                        if (activity is com.ovopark.cloudpos.ui.main.MainActivity) {
                            activity.setPendingInstallApk(apkFile.absolutePath)
                            LogManager.i("å·²å°†å¾…å®‰è£…APKè·¯å¾„è®¾ç½®åˆ°MainActivity: ${apkFile.absolutePath}")
                        } else {
                            LogManager.w("Contextä¸æ˜¯MainActivityï¼Œæ— æ³•è®¾ç½®å¾…å®‰è£…APK")
                        }
                    }
                    
                    
                    
                    /**
         * å¤„ç†å¾…å®‰è£…çš„APK
         * åœ¨onResumeæ—¶è°ƒç”¨ï¼Œç¡®ä¿åœ¨å‰å°çŠ¶æ€ä¸‹å®‰è£…
         */
        private fun handlePendingInstallApk() {
            pendingInstallApkPath?.let { apkPath ->
                LogManager.i("æ£€æµ‹åˆ°å¾…å®‰è£…APKï¼Œå¼€å§‹å®‰è£…: $apkPath")
                
                // æ£€æŸ¥æƒé™
                if (hasInstallPermission()) {
                    // å»¶è¿Ÿä¸€ç‚¹ç¡®ä¿Activityå®Œå…¨æ¢å¤
                    uiHandler.postDelayed({
                        try {
                            val apkFile = File(apkPath)
                            if (apkFile.exists()) {
                                installApkDirectly(apkFile)
                            } else {
                                LogManager.e("APKæ–‡ä»¶ä¸å­˜åœ¨: $apkPath")
                                showAddProductErrorPopup("APKæ–‡ä»¶ä¸å­˜åœ¨")
                            }
                        } catch (e: Exception) {
                            LogManager.e("å®‰è£…APKå¤±è´¥: ${e.message}", e)
                            showAddProductErrorPopup("å®‰è£…å¤±è´¥: ${e.message}")
                        }
                        // æ¸…é™¤å¾…å®‰è£…APKè·¯å¾„
                        pendingInstallApkPath = null
                    }, 1000) // å»¶è¿Ÿ1ç§’ç¡®ä¿Activityå®Œå…¨æ¢å¤
                } else {
                    LogManager.w("ä»ç„¶æ²¡æœ‰å®‰è£…æƒé™")
                    showAddProductErrorPopup("ä»ç„¶éœ€è¦å®‰è£…æƒé™")
                    pendingInstallApkPath = null
                }
            }
        }
        
        /**
         * ç›´æ¥å®‰è£…APK
         */
        private fun installApkDirectly(apkFile: File) {
            try {
                LogManager.i("ç›´æ¥å®‰è£…APK: ${apkFile.absolutePath}")
                
                val intent = Intent(Intent.ACTION_VIEW).apply {
                    flags = Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TOP
                    
                    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.N) {
                        // Android 7.0åŠä»¥ä¸Šä½¿ç”¨FileProvider
                        val apkUri = androidx.core.content.FileProvider.getUriForFile(
                            this@MainActivity,
                            "${packageName}.fileprovider",
                            apkFile
                        )
                        setDataAndType(apkUri, "application/vnd.android.package-archive")
                        addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
                    } else {
                        // Android 7.0ä»¥ä¸‹ç›´æ¥ä½¿ç”¨æ–‡ä»¶URI
                        setDataAndType(Uri.fromFile(apkFile), "application/vnd.android.package-archive")
                    }
                }
                
                startActivity(intent)
                LogManager.i("æˆåŠŸå¯åŠ¨APKå®‰è£…")
                showAddProductErrorPopup("å¼€å§‹å®‰è£…æ›´æ–°...")
                
            } catch (e: Exception) {
                LogManager.e("ç›´æ¥å®‰è£…APKå¤±è´¥: ${e.message}", e)
                showAddProductErrorPopup("å®‰è£…å¤±è´¥: ${e.message}")
                throw e
            }
        }
    ```

- ç»“æœï¼š

  - æŠ¥é”™å¦‚ä¸‹ï¼š

  - ```
    (ApkDownloadManager.kt:202) installApk() æ²¡æœ‰å®‰è£…æœªçŸ¥æ¥æºåº”ç”¨çš„æƒé™ï¼Œé€šçŸ¥éœ€è¦æƒé™
    2025-06-09 10:47:35.471 21588-21588 (LogManager.kt:156) w   com.ovopark.cloudpos                 W  (OtaUpdateDialog.kt:217) onNeedInstallPermission$lambda$7() éœ€è¦å®‰è£…æƒé™ï¼Œå°è¯•è¯·æ±‚æƒé™
    2025-06-09 10:47:35.478 21588-21588 Compatibil...geReporter com.ovopark.cloudpos                 D  Compat change id reported: 147798919; UID 10101; state: ENABLED
    2025-06-09 10:47:35.481 21588-21588 (LogManager.kt:156) w   com.ovopark.cloudpos                 W  (OtaUpdateDialog.kt:238) onNeedInstallPermission$lambda$7() Contextä¸æ˜¯MainActivityï¼Œæ— æ³•è®¾ç½®å¾…å®‰è£…APK
    2025-06-09 10:47:35.491   477-5953  ActivityTaskManager     system_server                        I  Launching r: ActivityRecord{540efd9 u0 com.android.settings/.Settings$ManageAppExternalSourcesActivity} from background: ActivityRecord{bfe075c u0 com.ovopark.cloudpos/.ui.main.MainActivity} t267}. New task: false
    2025-06-09 10:47:35.507 21588-21588 (LogManager.kt:149) i   com.ovopark.cloudpos                 I  (OtaUpdateDialog.kt:250) onNeedInstallPermission$lambda$7() æˆåŠŸå¯åŠ¨å®‰è£…æƒé™è®¾ç½®é¡µé¢
    2025-06-09 10:47:35.512 21588-21588 (LogManager.kt:149) i   com.ovopark.cloudpos                 I  (ApkDownloadManager.kt:251) cancelDownload() æ¸…é™¤apkä¸‹è½½çš„ä»»åŠ¡ï¼Œå…·ä½“æ˜¯å¦ä¸‹è½½å®Œæˆå‚è€ƒä¹‹å‰æ—¥å¿—
    2025-06-09 10:47:35.528   477-2661  CoreBackPreview         system_server                        D  Window{cea8f8e u0 com.ovopark.cloudpos/com.ovopark.cloudpos.ui.main.MainActivity}: Setting back callback null
    2025-06-09 10:47:35.532   477-6116  InputManager-JNI        system_server                        W  Input channel object 'cea8f8e com.ovopark.cloudpos/com.ovopark.cloudpos.ui.main.MainActivity (client)' was disposed without first being removed with the input manager!
    ```

### 5.4 ç¬¬äº”æ¬¡è§£å†³æ–¹æ¡ˆ

- åˆ†æï¼š

  - ä»æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒW  (OtaUpdateDialog.kt:238) onNeedInstallPermission$lambda$7() Contextä¸æ˜¯MainActivityï¼Œæ— æ³•è®¾ç½®å¾…å®‰è£…APK
  - åˆ†æä¸€ä¸‹é—®é¢˜ï¼šè¿™è¯´æ˜åœ¨OtaUpdateDialogä¸­ï¼Œcontextä¸æ˜¯MainActivityçš„å®ä¾‹ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºOtaUpdateDialogæ˜¯ä»å…¶ä»–åœ°æ–¹ï¼ˆæ¯”å¦‚UpdateManageræˆ–å…¶ä»–Activityï¼‰è°ƒç”¨çš„ï¼Œè€Œä¸æ˜¯ä»MainActivityè°ƒç”¨çš„ã€‚

- è§£å†³æ–¹æ¡ˆï¼š

  - æœ‰å‡ ä¸ªè§£å†³æ–¹æ¡ˆï¼š

    1. ä½¿ç”¨åº”ç”¨å…¨å±€çš„æ–¹å¼å­˜å‚¨å¾…å®‰è£…APKè·¯å¾„

    1. ä½¿ç”¨å¹¿æ’­æˆ–å…¶ä»–æœºåˆ¶é€šçŸ¥MainActivity

    1. ä¿®æ”¹è°ƒç”¨é“¾ï¼Œç¡®ä¿Contextæ˜¯MainActivity

  - ç›®å‰é‡‡ç”¨å…¨å±€æ–¹å¼å­˜å‚¨ï¼Œä½¿ç”¨SharedPreferencesæ¥å­˜å‚¨å¾…å®‰è£…APKè·¯å¾„ï¼Œè¿™æ ·ä»»ä½•Activityéƒ½èƒ½è®¿é—®ï¼š

    - ```
      // ä½¿ç”¨SharedPreferenceså­˜å‚¨å¾…å®‰è£…APKè·¯å¾„ï¼Œè¿™æ ·MainActivityå¯ä»¥åœ¨onResumeæ—¶æ£€æŸ¥
      val prefs = context.getSharedPreferences("app_update", android.content.Context.MODE_PRIVATE)
      prefs.edit().putString("pending_install_apk", apkFile.absolutePath).apply()
      LogManager.i("å·²å°†å¾…å®‰è£…APKè·¯å¾„ä¿å­˜åˆ°SharedPreferences: ${apkFile.absolutePath}")
      
       // ä»SharedPreferencesè¯»å–å¾…å®‰è£…APKè·¯å¾„
              val prefs = getSharedPreferences("app_update", MODE_PRIVATE)
              val apkPath = prefs.getString("pending_install_apk", null)
              
              apkPath?.let { path ->
                  LogManager.i("æ£€æµ‹åˆ°å¾…å®‰è£…APKï¼Œå¼€å§‹å®‰è£…: $path")
      ```

- ç»“æœï¼šæˆåŠŸè§£å†³é—®é¢˜



## 06.è¿›ä¸€æ­¥æ€è€ƒ

### 6.1 æœ‰æ²¡æœ‰å…¶ä»–æ›´ä¼˜é›…çš„æ–¹æ¡ˆ

- å½“å‰æ–¹æ¡ˆçš„é—®é¢˜ï¼š

  1. ä½¿ç”¨SharedPreferencesåœ¨ä¸åŒç»„ä»¶é—´ä¼ é€’APKè·¯å¾„ï¼Œæœ‰ç‚¹ä¸å¤Ÿä¼˜é›…

  1. éœ€è¦åœ¨MainActivityçš„onResumeä¸­æ£€æŸ¥å¾…å®‰è£…APKï¼Œå¢åŠ äº†MainActivityçš„å¤æ‚åº¦

  1. æƒé™å¤„ç†é€»è¾‘åˆ†æ•£åœ¨å¤šä¸ªåœ°æ–¹ï¼ˆOtaUpdateDialogã€MainActivityã€ApkDownloadManagerï¼‰

- å¯èƒ½çš„æ›´ä¼˜é›…æ–¹æ¡ˆï¼š

  - ä½¿ç”¨Applicationçº§åˆ«çš„å…¨å±€ç®¡ç†å™¨
    - åˆ›å»ºä¸€ä¸ªå…¨å±€çš„APKå®‰è£…ç®¡ç†å™¨ï¼Œåœ¨Applicationä¸­åˆå§‹åŒ–
    - æ‰€æœ‰å®‰è£…ç›¸å…³é€»è¾‘é›†ä¸­åœ¨è¿™ä¸ªç®¡ç†å™¨ä¸­
    - ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼æˆ–äº‹ä»¶æ€»çº¿æ¥é€šçŸ¥å®‰è£…çŠ¶æ€
  - ä½¿ç”¨å¹¿æ’­æ¥æ”¶å™¨
    - å½“ç”¨æˆ·ä»è®¾ç½®è¿”å›æ—¶ï¼Œå‘é€ä¸€ä¸ªå¹¿æ’­
    - æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨æ¥å¤„ç†å®‰è£…é€»è¾‘
    - æ›´ç¬¦åˆAndroidçš„äº‹ä»¶é©±åŠ¨æ¨¡å¼
  - ä½¿ç”¨Activity Result APIçš„æ”¹è¿›ç‰ˆæœ¬
    - åœ¨ä¸‹è½½ç®¡ç†å™¨ä¸­ç›´æ¥ä½¿ç”¨Activity Result API
    - é¿å…é€šè¿‡å¤šä¸ªç»„ä»¶ä¼ é€’çŠ¶æ€
  - ä½¿ç”¨Notification + PendingIntent
    - å½“éœ€è¦æƒé™æ—¶ï¼Œæ˜¾ç¤ºé€šçŸ¥è€Œä¸æ˜¯è·³è½¬
    - ç”¨æˆ·ç‚¹å‡»é€šçŸ¥åå¤„ç†å®‰è£…
    - æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

### 6.2 ä»–ä»¬å¯èƒ½çš„å®ç°

Applicationçº§åˆ«çš„å…¨å±€APKå®‰è£…ç®¡ç†å™¨ 

- ```
  *// åœ¨Applicationä¸­åˆ›å»ºå…¨å±€å®‰è£…ç®¡ç†å™¨*
  
  class ApkInstallManager {
  
    private var pendingApkFile: File? = null
  
    private val installCallbacks = mutableListOf<(Boolean) -> Unit>()
  
    
  
    fun setPendingInstall(apkFile: File, callback: (Boolean) -> Unit) {
  
  â€‹    pendingApkFile = apkFile
  
  â€‹    installCallbacks.add(callback)
  
    }
  
    
  
    fun handleInstallPermissionGranted(activity: Activity) {
  
  â€‹    pendingApkFile?.let { 
  
  â€‹      *// ç›´æ¥åœ¨è¿™é‡Œå¤„ç†å®‰è£…*
  
  â€‹    }
  
    }
  
  }
  ```

- ä¼˜åŠ¿ï¼š
  - é›†ä¸­ç®¡ç†æ‰€æœ‰å®‰è£…é€»è¾‘
  - é¿å…ç»„ä»¶é—´å¤æ‚çš„çŠ¶æ€ä¼ é€’
  - æ›´å¥½çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†

ä½¿ç”¨å¹¿æ’­æ¥æ”¶å™¨æ¨¡å¼ (æ¨èâ­â­â­â­)

- ```
  class InstallPermissionReceiver : BroadcastReceiver() {
  
    override fun onReceive(context: Context, intent: Intent) {
  
  â€‹    if (intent.action == "INSTALL_PERMISSION_GRANTED") {
  
  â€‹      *// å¤„ç†å®‰è£…é€»è¾‘*
  
  â€‹    }
  
    }
  
  }
  ```

- ä¼˜åŠ¿ï¼š

  - ç¬¦åˆAndroidäº‹ä»¶é©±åŠ¨æ¨¡å¼

  - ç»„ä»¶è§£è€¦ï¼Œæ›´æ¸…æ™°çš„èŒè´£åˆ†ç¦»

  - å¯ä»¥å¤„ç†å¤šä¸ªActivityçš„æƒ…å†µ

ä½¿ç”¨ç°ä»£Repository + StateFlowæ¨¡å¼ (æ¨èâ­â­â­â­â­)

- ```
  class UpdateRepository {
  
    private val _installState = MutableStateFlow<InstallState>(InstallState.Idle)
  
    val installState = _installState.asStateFlow()
  
    
  
    sealed class InstallState {
  
  â€‹    object Idle : InstallState()
  
  â€‹    object Downloading : InstallState()
  
  â€‹    data class NeedPermission(val apkFile: File) : InstallState()
  
  â€‹    object Installing : InstallState()
  
  â€‹    object Success : InstallState()
  
  â€‹    data class Error(val message: String) : InstallState()
  
    }
  
  }
  ```

- ä¼˜åŠ¿ï¼š

  - å“åº”å¼ç¼–ç¨‹ï¼ŒçŠ¶æ€ç®¡ç†æ¸…æ™°

  - æ›´å¥½çš„æµ‹è¯•æ€§

  - ç¬¦åˆç°ä»£Androidæ¶æ„æŒ‡å—

ä½¿ç”¨Notification + æ·±åº¦é“¾æ¥

- å½“éœ€è¦æƒé™æ—¶ï¼Œæ˜¾ç¤ºæŒä¹…åŒ–é€šçŸ¥ï¼Œç”¨æˆ·ç‚¹å‡»åï¼š

- è·³è½¬åˆ°æƒé™è®¾ç½®

- é€šè¿‡æ·±åº¦é“¾æ¥è¿”å›åº”ç”¨å¹¶è§¦å‘å®‰è£…

- ä¼˜åŠ¿ï¼š
  - ç”¨æˆ·ä½“éªŒæ›´å¥½ï¼Œä¸ä¼šä¸¢å¤±ä¸Šä¸‹æ–‡
  - æƒé™è¯·æ±‚æ›´æ˜ç¡®
  - æ”¯æŒåå°å¤„ç†

ä½¿ç”¨ç¬¬ä¸‰æ–¹æˆç†Ÿæ–¹æ¡ˆ (æ¨èâ­â­â­â­)

- å¦‚ä½¿ç”¨ AppUpdater åº“æˆ– UpdatePluginï¼š

- ```
  AppUpdater(this)
  
    .setUpdateFrom(UpdateFrom.JSON)
  
    .setUpdateJSON(updateUrl)
  
    .setTitleOnUpdateAvailable("Update available")
  
    .setContentOnUpdateAvailable("Check out the latest version!")
  
    .setTitleOnUpdateNotAvailable("Update not available")
  
    .setContentOnUpdateNotAvailable("No update available")
  
    .setButtonUpdate("Update now?")
  
    .setButtonDismiss("Maybe later")
  
    .setButtonDoNotShowAgain("Huh, not interested")
  
    .setIcon(R.drawable.ic_update)
  
    .setBtnUpdateTextColor(Color.WHITE)
  
    .setBtnUpdateBackgroundColor(Color.BLUE)
  
    .start()
  ```

- ä¼˜åŠ¿ï¼š

  - ä¹…ç»æµ‹è¯•çš„ç¨³å®šæ–¹æ¡ˆ
  - å¼€ç®±å³ç”¨ï¼Œå‡å°‘å¼€å‘æ—¶é—´
  - ç¤¾åŒºç»´æŠ¤ï¼Œbugä¿®å¤åŠæ—¶

### 6.2 æ¨èæ–¹æ¡ˆ

```

```



## 07.ç»éªŒæ€»ç»“

### 7.1 æŠ€æœ¯åŸç†

### 7.2 é¢„é˜²æªæ–½

### 7.3 å¸è½½è§„èŒƒ

### 7.4 è°ƒè¯•æŠ€å·§

