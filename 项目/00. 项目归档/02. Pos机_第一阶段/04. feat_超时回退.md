[toc]

## 01.功能概述

- **功能ID**：`FEAT-20250609-001`  
- **功能名称**：购物车主页超时未操作回退功能  
- **目标版本**：v0.5.0
- **提交人**：@panruiqi  
- **状态**：
  - [x] ⌛ 设计中 /
  - [ ] ⌛ 开发中 / 
  - [ ] ✅ 已完成 / 
  - [ ] ❌ 已取消  
- **价值评估**：  
  - [x] ⭐⭐⭐⭐⭐ 核心业务功能  
  - [ ] ⭐⭐⭐⭐ 用户体验优化  
  - [ ] ⭐⭐⭐ 辅助功能增强  
  - [ ] ⭐⭐ 技术债务清理  
- **功能描述** 
  - 实现MainActivity中右上角取消按钮的复用。当用户处于购物车页面，5s时间没有操作，那么右上角就会显示（清空120s）倒计时。



## 02.需求分析

### 2.1 用户场景

- **主要场景**：  

  - 用户A扫描了一些商品，购物车有商品，显示购物车页面

  - 用户A突然有事离开，没有完成结账，也没有清空购物车

  - 机器就会一直停留在购物车页面，显示用户A的商品

  - 用户B来使用机器时，会看到用户A的购物车

  - 为了避免这种情况，需要检测用户无操作后自动清空

- **边界场景**：  

### 2.2 功能范围

- ✅ 包含：
- ❌ 不包含：



## 03.技术方案

### 3.1 方案一

- 实现思路：
  - 我设置一个PausableCountDownTimer定时器，onTick的时候设置文字。onCreate时启动它。
  - 去覆写BaseScannerActivity中的onKeyDown方法，每次出发，就reset定时器。
  - 去复写onTouchEvents方法，每次触发，就reset定时器。

### 3.2 方案二

- 实现思路：

  - Activity只负责收集用户交互事件，传递给ViewModel

  1. ViewModel处理所有业务逻辑，管理状态

  1. Activity观察ViewModel状态变化，更新UI

## 04.实现规划

### 4.1 技术选型

- 方案一存在下列问题：

  - 优点：

    ✅ 逻辑直观：定时器 + 重置机制很容易理解

    ✅ 实现相对简单：覆写现有方法即可

  - 潜在问题：

    ❌ 交互检测不完整：onKeyDown + onTouchEvent 可能遗漏其他交互方式

    ❌ 定时器生命周期复杂：需要处理暂停、恢复、销毁等状态

    ❌ 代码分散：重置逻辑散布在多个方法中，容易遗漏

    ❌ 与业务逻辑耦合：定时器逻辑和MainActivity耦合度高

- 方案二更符合MVVM架构的思路，UI和ViewModel责任分明。

### 4.2 技术详细设计

1. ViewModel层 - 状态管理

- 状态定义：隐藏/显示按钮/倒计时三个状态

- 计时器管理：5秒无操作检测 + 120秒倒计时

- 用户活动响应：重置所有计时器

- 购物车监听：空车停止检测，有商品开始检测

2. Activity层 - 交互检测

- 全局触摸监听：binding.root.setOnTouchListener

- 按键监听：dispatchKeyEvent覆写(处理扫码枪)

- 状态观察：观察ViewModel状态更新UI

3. UI更新逻辑

- 隐藏状态：按钮显示"清空"，普通颜色

- 警告状态：按钮闪烁，提示即将倒计时

- 倒计时状态：按钮显示"清空(120s)"，倒计时减少

4. 生命周期管理

- onPause：暂停所有检测

- onResume：恢复检测(如果有商品)

- onDestroy：取消所有协程

### 4.2 任务拆解

- 

### 4.3 代码路径

- **新增文件**：
  `app/src/main/java/.../NewFeature.kt`
- **修改文件**：
  `ExistingClass.kt`（方法扩展）
- **资源文件**：
  `res/layout/new_feature.xml`





## 05.兼容性设计

### 5.1 设备适配

- **屏幕尺寸**：小屏设备折叠布局方案
- **系统版本**：

### 5.2 冲突检查

| 现有功能 | 冲突风险     | 解决方案 |
| :------- | :----------- | :------- |
| 功能A    | 接口参数变更 | 版本隔离 |

## 06.测试方案

### 6.1 核心用例

### 6.2 性能指标

| 指标       | 预期值 | 实测值 |
| :--------- | :----- | :----- |
| 内存增量   | <1MB   | -      |
| 渲染帧率   | >55fps | -      |
| 冷启动延迟 | <100ms | -      |

## 07.发布计划

### 7.1 阶段发布

| 阶段  | 范围     | 验证重点 |
| :---- | :------- | :------- |
| Alpha | 内部测试 | 核心流程 |
| Beta  | 5%用户   | 崩溃率   |
| GA    | 全量用户 | 性能指标 |

### 7.2 回滚方案

- 热修复开关：
- 动态配置：





## 08.文档记录

### 8.1 技术文档

- [架构设计文档](https://xn--gzu811i/)
- [接口API文档](https://xn--gzu811i/)

### 8.2 用户文档

- 功能引导页设计
- 错误代码对照表

### 8.3 监控埋点

```
// analytics_events.json
{
  "new_feature_used": {
    "params": ["screen_size", "os_version"]
  }
}
```

