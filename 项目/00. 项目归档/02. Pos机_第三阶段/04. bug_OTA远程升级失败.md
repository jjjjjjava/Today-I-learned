[toc]

## 01.功能概述

- **[优先级] **
  - [ ] ⚠️ 阻断 (Blocker)：系统崩溃、核心功能完全不可用
  - [ ] 🔴 严重 (Critical)：核心功能受损，无可用替代方案
  - [ ] 🟠 高 (High)：主要功能受影响，但有临时解决方案
  - [ ] 🟡 中 (Medium)：次要功能问题，影响用户体验
  - [ ] 🟢 低 (Low)：界面问题或轻微异常，不影响功能
- **问题简要描述**
  - **Bug ID**：`BUG-20240715-001`  
  - **影响版本**：v0.3.0
  - **提交人**：@panruiqi
  - **状态**：
    - [ ] ⌛ 修复中 /
    - [x] ✅ 已解决 / 
    - [ ] ❌ 无法复现  

- **问题现象**
  - v0.2.2的包进行远程更新，更新失败，不进行下载操作，仍为v0.2.2。
  - 清空缓存后更新成功，为v0.3.0
- **环境特征**
  - 

## 02.问题分析

### 2.1 日志分析

- ![image-20250715220124546](../../_pic_/image-20250715220124546.png)

### 2.2 根本原因推理

- 状态管理出现问题，导致产生无效的状态转移。
  - 状态机从持久化存储中恢复时，保持在了之前的Success状态（即之前成功下载了旧版本0.2.2的APK）
  - 当检测到新版本0.3.0时，系统尝试开始下载，但状态转换逻辑不允许从Success状态转换到StartDownload
- 同时没有清除正确路径下的包缓存

## 03.代码分析

### 3.1 关联代码路径

- 

### 3.2 可疑修改点

- 

## 04.复现步骤



## 05.解决方案尝试

### 5.1 第一次解决方案

- 分析：参考根因推理
  - 
- 解决方案：
  - 新增状态复位以及缓存清空
  - ![image-20250715220311644](../../_pic_/image-20250715220311644.png)
  - ![image-20250715220329478](../../_pic_/image-20250715220329478.png)
  - ![image-20250715220412023](../../_pic_/image-20250715220412023.png)
- 结果：
  - 确保初始状态为Idle：
    - 修改了DownloadStateMachine的init块，在启动时检查当前状态，如果是Success状态则重置为Idle
    - 在downloadApk方法中显式调用reset()确保从Idle状态开始下载流程
  - 增加缓存清理功能：
    - 添加了完善的clearCacheIfNeeded方法，清理所有可能的APK缓存
    - 清理下载目录及其父目录中的所有APK文件
    - 处理状态机中Success状态的缓存文件
  - 应用现在会在每次启动时重置为Idle状态，避免状态机卡在Success状态
    - 在每次下载新版本前，会清理所有旧的APK缓存文件
    - 确保每次都会下载服务器上的最新版本，而不是使用本地缓存的旧版本
    - 这样，当检测到新版本0.3.0时，系统会清理旧的0.2.2版本缓存，并重新下载新版本，确保OTA更新流程正确执行。

### 5.2 第二次解决方案

- 分析：
- 解决方案：
  - 
- 结果：
  - 

### 5.3 第三次解决方案

- 分析：
  - 
- 解决方案：
  - 
- 结果：
  - 

### 5.4 第四次解决方案

- 分析：
  - 

- 解决方法：
  - 
- 结果：
  - 

### 5.4 第五次解决方案

- 分析：
  - 
- 解决方案：
  - 
- 结果：成功解决问题



## 06.进一步思考

### 6.1 有没有其他更优雅的方案

- 

### 6.2 推荐方案

```

```



## 07.根本原因和修复

### 7.1 最终定位

- 


### 7.2 修复方案



## 08.经验总结

### 8.1 技术原理

### 8.2 预防措施

### 8.3 卸载规范

### 8.4 调试技巧



