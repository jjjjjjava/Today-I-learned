[toc]

## 01.功能概述

- **功能ID**：`FEAT-20250609-001`  
- **功能名称**：
- **目标版本**：v0.2.0
- **提交人**：@panruiqi  
- **状态**：
  - [x] ⌛ 设计中 /
  - [ ] ⌛ 开发中 / 
  - [ ] ✅ 已完成 / 
  - [ ] ❌ 已取消  
- **价值评估**：  
  - [x] ⭐⭐⭐⭐⭐ 核心业务功能  
  - [ ] ⭐⭐⭐⭐ 用户体验优化  
  - [ ] ⭐⭐⭐ 辅助功能增强  
  - [ ] ⭐⭐ 技术债务清理  
- **功能描述** 
  - 可以蓝牙搜索连接到对应的设备
  - 并给其传递wifi账号密码。
  - 同时可以检测其是否成功连接网络

## 02.需求分析

### 2.1 用户场景

- **主要场景**：  
- APP搜索设备（蓝牙），没找到持续搜索一段时间，
  - 找到设备后APP，连接设备
  - 扫描可用的wifi。
  - 找到后选中wifi，交给设备，让其连接wifi
  - 然后监听设备是否连接wifi成功，连接成功后调用接口查看设备是否被注册过。
  
- **边界场景**：  

### 2.2 功能范围

- ✅ 包含：
- ❌ 不包含：



## 03.技术方案

### 3.1 方案一

- 实现思路：
  - 使用SDK，封装一个管理类 + helper类简化使用。

### 3.2 方案二

- 实现思路：



## 04.实现规划

### 4.1 技术选型



### 4.2 任务拆解

ESP32DeviceManager

- 搜索设备：
  - ![image-20250717190534971](../../_pic_/image-20250717190534971.png)
- 连接设备
  - ![image-20250717190609483](../../_pic_/image-20250717190609483.png)
- 配置wifi
  - ![image-20250717190630911](../../_pic_/image-20250717190630911.png)
- 检测设备是否被注册
  - ![image-20250717190658976](../../_pic_/image-20250717190658976.png)

### 4.3 代码路径



### 4.4 快速使用指南

这个ESP32ConfigHelper类大大简化了ESP32DeviceManager的使用流程。使用示例：

- 初始化

  - ```
    // 在Activity或Fragment中初始化
    val configHelper = ESP32ConfigHelper(context)
    ```

- 设备搜索

  - ```
    // 开始搜索设备
    configHelper.startScan()
    
    // 监听搜索状态
    configHelper.searchState.observe(lifecycleOwner) { state ->
        when(state) {
            is ESP32DeviceManager.SearchState.Searching -> {
                // 显示搜索中UI
            }
            is ESP32DeviceManager.SearchState.DevicesFound -> {
                // 显示找到设备UI
            }
            // 处理其他状态...
        }
    }
    
    // 监听找到的设备列表
    configHelper.deviceList.observe(lifecycleOwner) { devices ->
        // 更新设备列表UI
        deviceAdapter.submitList(devices)
    }
    ```

- 一键配网、

  - ```
    // 选中一个设备
    val selectedDevice = deviceList[position]
    
    // 执行完整配网流程
    configHelper.executeCompleteProvisioningFlow(
        selectedDevice,
        "YourWifiSSID", 
        "YourWifiPassword"
    ) { success, error, registered ->
        if (success) {
            if (registered == true) {
                // 配网成功且设备已注册
                showToast("设备配网成功且已注册")
            } else {
                // 配网成功但设备未注册
                showToast("设备配网成功但未注册，需要完成注册")
                // 跳转到设备注册页面
            }
        } else {
            // 配网失败
            showToast("配网失败：$error")
        }
    }
    ```

- 分步配网

  - ```
            // 1. 连接设备
            configHelper.connectDevice(selectedDevice) { success, error ->
                if (!success) {
                    showToast("连接设备失败：$error")
                    return@connectDevice
                }
        
            // 2. 配置WiFi
            configHelper.configureWifi("YourWifiSSID", "YourWifiPassword") { wifiSuccess, wifiError ->
                if (!wifiSuccess) {
                    showToast("WiFi配置失败：$wifiError")
                    return@configureWifi
                }
            
            // 3. 检查设备注册状态
            configHelper.checkDeviceRegistration(selectedDevice.macAddress) { registered, regError ->
                if (regError != null) {
                    showToast("检查注册状态失败：$regError")
                } else if (registered) {
                    showToast("设备已注册")
                } else {
                    showToast("设备未注册，请完成注册")
                    // 跳转到注册页面
                }
                
                // 断开设备连接
                configHelper.disconnectDevice()
            }
        }
    }
    ```

- 生命周期管理

  - ```
    override fun onDestroy() {
        // 确保停止扫描和断开连接
        configHelper.stopScan()
        configHelper.disconnectDevice()
        super.onDestroy()
    }
    ```


## 05.兼容性设计

### 5.1 设备适配



### 5.2 冲突检查

- 出现如下冲突
  - ![image-20250717133026020](../../_pic_/image-20250717133026020.png)

- 使用一次大清解决，也就是清空缓存

## 06.测试方案

### 6.1 核心用例



### 6.2 性能指标



## 07.发布计划

### 7.1 阶段发布



### 7.2 回滚方案



## 08.文档记录

### 8.1 技术文档



### 8.2 用户文档



### 8.3 监控埋点



