[toc]

## 01.åŠŸèƒ½æ¦‚è¿°

- **[ä¼˜å…ˆçº§] **
  - [ ] âš ï¸ é˜»æ–­ (Blocker)ï¼šç³»ç»Ÿå´©æºƒã€æ ¸å¿ƒåŠŸèƒ½å®Œå…¨ä¸å¯ç”¨
  - [ ] ğŸ”´ ä¸¥é‡ (Critical)ï¼šæ ¸å¿ƒåŠŸèƒ½å—æŸï¼Œæ— å¯ç”¨æ›¿ä»£æ–¹æ¡ˆ
  - [ ] ğŸŸ  é«˜ (High)ï¼šä¸»è¦åŠŸèƒ½å—å½±å“ï¼Œä½†æœ‰ä¸´æ—¶è§£å†³æ–¹æ¡ˆ
  - [ ] ğŸŸ¡ ä¸­ (Medium)ï¼šæ¬¡è¦åŠŸèƒ½é—®é¢˜ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ
  - [ ] ğŸŸ¢ ä½ (Low)ï¼šç•Œé¢é—®é¢˜æˆ–è½»å¾®å¼‚å¸¸ï¼Œä¸å½±å“åŠŸèƒ½
- **é—®é¢˜ç®€è¦æè¿°**
  - **Bug ID**ï¼š`BUG-202406010-001`  
  - **å‘ç°æ—¥æœŸ**ï¼š2025-06-010  
  - **å½±å“ç‰ˆæœ¬**ï¼šv0.3.0 (build 450)  
  - **æäº¤äºº**ï¼š@panruiqi  
  - **çŠ¶æ€**ï¼š
  - [ ] âŒ› ä¿®å¤ä¸­ /
    - [ ]  âœ… å·²è§£å†³ / 
    - [ ] âŒ æ— æ³•å¤ç°  /
  
- **é—®é¢˜ç°è±¡**
  - åç«¯æŠ¥å‘ŠAPIå‚æ•°é”™è¯¯ï¼Œé—¨åº—IDä¸ç¬¦åˆã€‚
  - æ•´ä¸ªæ‰«ç æŸ¥è¯¢å•†å“ï¼Œç”Ÿæˆè®¢å•ï¼Œæ‰«ç ä»˜æ¬¾çš„æµç¨‹éƒ½ä¸é€šè¿‡ã€‚
- **ç¯å¢ƒç‰¹å¾**
  - è®¾å¤‡å‹å·: Pixel 6 Pro / Xiaomi 13
  - OSç‰ˆæœ¬: Android 14 (API 34)
  - ç½‘ç»œç¯å¢ƒ: å…¬å¸å†…ç½‘/WiFi
  - ç”¨æˆ·è´¦æˆ·: primary_user (ID:0)

## 02.é—®é¢˜åˆ†æ

### 2.1 æ—¥å¿—åˆ†æ

- 

### 2.2 æ ¹æœ¬åŸå› æ¨ç†

- 

## 03.ä»£ç åˆ†æ

### 3.1 å…³è”ä»£ç è·¯å¾„

- paymentRepositoryï¼ŒQrcodeRepositoryï¼ŒScannerRepository

- ```
  // åˆ›å»ºè¯·æ±‚ï¼ŒåŒ…å«wdzDeptId
  val request = CartSettleRequest(
  wdzDeptId = Constants.TestProject.WDZ_DEPT_ID, // ä½¿ç”¨ç»Ÿä¸€çš„éƒ¨é—¨IDå¸¸é‡
  skuList = skuList
  )
  ```

### 3.2 å¯ç–‘ä¿®æ”¹ç‚¹

- 

## 04.å¤ç°æ­¥éª¤

- å¿…ç°



## 05.è§£å†³æ–¹æ¡ˆå°è¯•

### 5.1 ç¬¬ä¸€æ¬¡è§£å†³æ–¹æ¡ˆ

- åˆ†æï¼š
  - å‘ç°æ­£å¼ç‰ˆæ¥å£éœ€è¦éªŒè¯wdzdeptIdï¼ˆæµ‹è¯•ç‰ˆæ—¶è¯¥å­—æ®µè¢«å†™æ­»ï¼‰
- è§£å†³æ–¹æ¡ˆï¼š
  - æˆ‘ä½¿ç”¨PerferenceManagerå…¨å±€å”¯ä¸€å•ä¾‹ä¿å­˜ï¼Œæä¾›saveDeviceIdå’ŒgetDeviceIdæ–¹æ³•ï¼Œå…¶ä»–ä½ç½®é€šè¿‡Koinä¾èµ–æ³¨å…¥å¯¼å…¥è¿™ä¸ªå•ä¾‹ã€‚ç„¶åç™»é™†éªŒè¯ä»“åº“ä½ç½®saveï¼Œå…¶ä»–apiä»“åº“ä½ç½®getã€‚
- ç»“æœï¼š
  - è§£å†³é—®é¢˜

### 5.2 ç¬¬äºŒæ¬¡è§£å†³æ–¹æ¡ˆ

- åˆ†æï¼š

  - ä¸Šä¸€æ¬¡çš„è§£å†³æ–¹æ³•ï¼Œå­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š

    - ä»–çš„ä»£ç ä¾µå…¥æ€§è¿‡é«˜ã€‚è®¤çœŸè€ƒé‡ä»£ç é€»è¾‘ï¼Œåç»­çš„APIå…¶å®éƒ½éœ€è¦ä½¿ç”¨é—¨åº—IDã€‚
    - é‡‡ç”¨perferenceï¼Œä½¿ç”¨å¤–å­˜ï¼Œæ€§èƒ½æœ‰å½±å“

  - æ€è€ƒï¼šæˆ‘æœ‰å¿…è¦å°†ä»–ä»å¤–å­˜æ”¹åˆ°å†…å­˜å—ï¼Ÿç°åœ¨æˆ‘è¿›è¡Œç½‘ç»œè¯·æ±‚ï¼Œå»¶è¿Ÿæ—¶110msï¼Œä½ è§‰å¾—å¤–å­˜åˆ°å†…å­˜çš„ä¼˜åŒ–å¤§å—ï¼Ÿæœ‰å¿…è¦å—ï¼Ÿ

    - SharedPreferencesè¯»å–æ€§èƒ½ï¼š

      - é¦–æ¬¡è¯»å–ï¼š1-5msï¼ˆä»ç£ç›˜åŠ è½½ï¼‰

      - åç»­è¯»å–ï¼š0.1-1msï¼ˆAndroidå·²ç¼“å­˜åœ¨å†…å­˜ï¼‰

    - ç½‘ç»œè¯·æ±‚å»¶è¿Ÿï¼š110ms

      - Preferenceè¯»å–ï¼š~1ms

      - ä¼˜åŒ–æ”¶ç›Šï¼š0.9% (1/110)

      è¿™ç§ä¼˜åŒ–ç¡®å®æ˜¯è¿‡åº¦ä¼˜åŒ–ï¼Œæ”¶ç›Šå¾®ä¹å…¶å¾®ã€‚

  - çœŸæ­£çš„é—®é¢˜ä¸æ˜¯æ€§èƒ½ï¼Œè€Œæ˜¯ï¼š

    1. ä»£ç ä¾µå…¥æ€§ï¼šæ¯ä¸ªRepositoryéƒ½è¦æ‰‹åŠ¨è·å–deptId

    1. ç»´æŠ¤å¤æ‚åº¦ï¼šåˆ†æ•£åœ¨å¤šå¤„çš„ç›¸åŒé€»è¾‘

    1. æµ‹è¯•éš¾åº¦ï¼šä¾èµ–æ³¨å…¥é“¾æ¡é•¿

- è§£å†³æ–¹æ¡ˆï¼š
  
  - æ‰€æœ‰deptIdé€»è¾‘é›†ä¸­åœ¨ä¸€ä¸ªæ‹¦æˆªå™¨ä¸­ï¼Œé€šè¿‡æ‹¦æˆªå™¨è¿›è¡ŒdeptIdçš„æ³¨å…¥
    
  - ```
    /**
     * éƒ¨é—¨IDè‡ªåŠ¨æ³¨å…¥æ‹¦æˆªå™¨
     * 
     * åŠŸèƒ½ï¼š
     * - è‡ªåŠ¨ä¸ºéœ€è¦çš„APIè¯·æ±‚æ·»åŠ wdzdeptIdå‚æ•°
     * - æ”¯æŒGETå’ŒPOSTè¯·æ±‚çš„ä¸åŒå¤„ç†æ–¹å¼
     * - æ™ºèƒ½æ’é™¤ä¸éœ€è¦deptIdçš„ç‰¹å®šAPI
     * - ä¼˜å…ˆä½¿ç”¨ä¿å­˜çš„çœŸå®è®¾å¤‡IDï¼Œå›é€€åˆ°æµ‹è¯•ID
     */
    class DeptIdBridgeInterceptor(
        private val preferenceManager: PreferenceManager
    ) : Interceptor {
    
    	companion object {
            // ä¸éœ€è¦deptIdçš„APIè·¯å¾„ï¼ˆé»‘åå•ï¼‰
            private val EXCLUDED_PATHS = setOf(
                "ovopark-device-manage/feign/yzs/getYzsDeviceStatusByMac",
                "auth/validate-token"
            )
    
            // ç»Ÿä¸€çš„å‚æ•°åç§°
            private const val DEPT_ID_PARAM_NAME = "wdzDeptId"
        }
        
        override fun intercept(chain: Interceptor.Chain): Response {
            val userRequest = chain.request()
            val requestBuilder = userRequest.newBuilder()
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦å¤„ç†
            if (shouldBypassDeptIdInjection(userRequest)) {
                return chain.proceed(userRequest)
            }
            
            // æ¡¥æ¥ï¼šæ³¨å…¥ä¸šåŠ¡å±‚å¿…éœ€çš„éƒ¨é—¨ID
            val deptId = preferenceManager.getApiDeptId()
            val networkRequest = when (userRequest.method) {
                "GET" -> buildGetRequestWithDeptId(requestBuilder, userRequest, deptId)
                "POST" -> buildPostRequestWithDeptId(requestBuilder, userRequest, deptId)
                else -> userRequest
            }
            
            return chain.proceed(networkRequest)
        }
        
        private fun shouldBypassDeptIdInjection(request: Request): Boolean {
            val path = request.url.encodedPath
            return EXCLUDED_PATHS.any { excluded -> path.contains(excluded, ignoreCase = true) }
        }
        
        private fun buildGetRequestWithDeptId(
            builder: Request.Builder, 
            original: Request, 
            deptId: String
        ): Request {
            val enhancedUrl = original.url.newBuilder()
                .addQueryParameter("wdzDeptId", deptId)
                .build()
            return builder.url(enhancedUrl).build()
        }
        
        private fun buildPostRequestWithDeptId(
            builder: Request.Builder,
            original: Request,
            deptId: String
        ): Request {
            val originalBody = original.body ?: return original
            val enhancedBody = enhanceRequestBodyWithDeptId(originalBody, deptId)
            return builder.post(enhancedBody).build()
        }
        
        // ... å…¶ä»–è¾…åŠ©æ–¹æ³•
    }
    
    
    // ğŸ”¸ åˆ›å»ºæ™®é€šçš„ OkHttpClient (ç”¨äºAPIè¯·æ±‚)
        single {
            OkHttpClient.Builder()
                .connectTimeout(Constants.Network.CONNECT_TIMEOUT, TimeUnit.SECONDS)
                .readTimeout(Constants.Network.READ_TIMEOUT, TimeUnit.SECONDS)
                .writeTimeout(Constants.Network.WRITE_TIMEOUT, TimeUnit.SECONDS)
                .addInterceptor(get<DeptIdInterceptor>())    // ğŸ¯ æ·»åŠ éƒ¨é—¨IDæ‹¦æˆªå™¨
                .addInterceptor(get<HttpLoggingInterceptor>())
                .build()
        }
    ```
    
  
- ç»“æœï¼š
  
  - 

### 5.3 ç¬¬ä¸‰æ¬¡è§£å†³æ–¹æ¡ˆ

- åˆ†æï¼šæœ‰ç‚¹æ„æ€ï¼Œæœ‰æ²¡æœ‰å…¶ä»–çš„æ–¹æ³•ï¼Ÿ
  
  - åˆ©ç”¨ Retrofit çš„å‚æ•°æ³¨å…¥æœºåˆ¶
- è§£å†³æ–¹æ¡ˆï¼š
  
  - åŠ¨æ€æŸ¥è¯¢å‚æ•°æ³¨å…¥(@QueryMap)
  
    - ä¼ ç»Ÿå†™æ³•ï¼ˆéœ€è¦æ¯æ¬¡æ‰‹åŠ¨ä¼ é€’ï¼‰ï¼š
  
    - ```
      @GET("on-duty-service/goods/queryGoodsByScanNo")
      suspend fun getProductByBarcode(
          @Query("scanNo") barcode: String,
          @Query("wdzDeptId") deptId: String,  // æ¯æ¬¡éƒ½è¦ä¼ 
          @Header("Ovo-Authorization") token: String
      ): ApiResponse<Product>
      ```
  
    - å‚æ•°æ³¨å…¥å†™æ³•ï¼ˆåŠ¨æ€ç»„è£…å‚æ•°ï¼‰ï¼š
  
    - ```
      @GET("on-duty-service/goods/queryGoodsByScanNo")
      suspend fun getProductByBarcode(
          @QueryMap params: Map<String, String>,  // åŠ¨æ€å‚æ•°æ˜ å°„
          @Header("Ovo-Authorization") token: String
      ): ApiResponse<Product>
      ```
  
    >  @QueryMap params: Map<String, String>, æ˜¯å¯ä»¥å®¹çº³å¤šä¸ªå‚æ•°å—ï¼Ÿ
    >
    > æ˜¯çš„ï¼Œæ ¹æ®Retrofitçš„æ–‡æ¡£ï¼Œ@QueryMapæ³¨è§£ç”¨äºåœ¨GETè¯·æ±‚ä¸­ä¼ é€’å¤šä¸ªæŸ¥è¯¢å‚æ•°ï¼ˆå³URLä¸­?åé¢çš„é”®å€¼å¯¹ï¼‰
    >
    > å®ƒæ¥æ”¶ä¸€ä¸ªMap<String, String>æˆ–Map<String, List<String>>ï¼ˆæˆ–è€…æ›´å¤æ‚çš„ç±»å‹ï¼Œä½†å¸¸è§çš„æ˜¯è¿™ä¸¤ç§ï¼‰
    >
    > å…·ä½“è¯´æ˜ï¼š
    >
    > \1. å½“ä½¿ç”¨Map<String, String>æ—¶ï¼Œæ¯ä¸ªé”®å€¼å¯¹ä¼šè¢«è½¬æ¢æˆä¸€ä¸ªæŸ¥è¯¢å‚æ•°ï¼Œä¾‹å¦‚ï¼š
    >
    > mapOf("key1" to "value1", "key2" to "value2")
    >
    > ä¼šå˜æˆ ?key1=value1&key2=value2
    >
    > 
    >
    > \2. å½“ä½¿ç”¨Map<String, List<String>>æ—¶ï¼ŒåŒä¸€ä¸ªé”®å¯ä»¥å¯¹åº”å¤šä¸ªå€¼ï¼Œä¾‹å¦‚ï¼š
    >
    > mapOf("key" to listOf("value1", "value2"))
    >
    > ä¼šå˜æˆ ?key=value1&key=value2
    >
    > 
    >
    > \3. å¦å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å…¶ä»–ç±»å‹çš„Mapï¼Œæ¯”å¦‚Map<String, Object>ï¼Œä½†æ˜¯Retrofitä¼šè°ƒç”¨æ¯ä¸ªå¯¹è±¡çš„toString()æ–¹æ³•è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚
  
  - å‚æ•°æ³¨å…¥å™¨å®ç°
  
    - ```
      /**
       * APIå‚æ•°æ³¨å…¥å™¨ - åœ¨ Repository å±‚è‡ªåŠ¨ç»„è£…å‚æ•°
       */
      class ApiParameterInjector(
          private val preferenceManager: PreferenceManager
      ) {
          
          /**
           * ä¸ºå•†å“æŸ¥è¯¢APIæ³¨å…¥å¿…éœ€å‚æ•°
           */
          fun forProductQuery(barcode: String): Map<String, String> {
              return mapOf(
                  "scanNo" to barcode,
                  "wdzDeptId" to preferenceManager.getApiDeptId()  // è‡ªåŠ¨æ³¨å…¥
              )
          }
          
          /**
           * é€šç”¨å‚æ•°æ³¨å…¥æ–¹æ³•
           */
          fun injectCommonParams(customParams: Map<String, String> = emptyMap()): Map<String, String> {
              val commonParams = mutableMapOf<String, String>()
              
              // è‡ªåŠ¨æ·»åŠ éƒ¨é—¨IDï¼ˆå¦‚æœéœ€è¦ï¼‰
              commonParams["wdzDeptId"] = preferenceManager.getApiDeptId()
              
              // å¯ä»¥æ·»åŠ å…¶ä»–é€šç”¨å‚æ•°
              commonParams["timestamp"] = System.currentTimeMillis().toString()
              commonParams["version"] = "1.0"
              
              // åˆå¹¶è‡ªå®šä¹‰å‚æ•°
              return commonParams + customParams
          }
      }
      ```
  
  - ä»“åº“å±‚ä¸­ä½¿ç”¨
  
    - ```
      class ScannerRepository(
          private val productService: ProductService,
          private val parameterInjector: ApiParameterInjector  // æ³¨å…¥å‚æ•°å¤„ç†å™¨
      ) {
          
          suspend fun getProductByBarcode(barcode: String): ApiResult<Product> {
              return try {
                  val token = Constants.TestProject.TOKEN
                  
                  // âœ… ä½¿ç”¨å‚æ•°æ³¨å…¥å™¨ï¼Œè‡ªåŠ¨å¤„ç† wdzDeptId
                  val params = parameterInjector.forProductQuery(barcode)
                  
                  val response = productService.getProductByBarcode(params, token)
                  
                  if (!response.isError && response.data != null) {
                      ApiResult.Success(response.data)
                  } else {
                      ApiResult.Error(Exception(response.message))
                  }
              } catch (e: Exception) {
                  ApiResult.Error(e)
              }
          }
      }
      ```
  
  - å¾ˆæœ‰æ„æ€ï¼Œä½†æ˜¯æ— æ³•é¿å…ä¾µå…¥å¼ä»£ç ï¼Œä½†æ˜¯å¾ˆå¤§ç¨‹åº¦é™ä½äº†å†…éƒ¨ç¼–è¾‘ä»£ç çš„è¦æ±‚ï¼Œåªéœ€è¦é€šè¿‡å‚æ•°æ³¨å…¥å™¨ç»Ÿä¸€ç®¡ç†å³å¯ã€‚
- ç»“æœï¼š
  
  - 

### 5.4 ç¬¬å››æ¬¡è§£å†³æ–¹æ¡ˆ

- åˆ†æï¼š
  - 

- è§£å†³æ–¹æ³•ï¼š
  - 
- ç»“æœï¼š
  - 

### 5.4 ç¬¬äº”æ¬¡è§£å†³æ–¹æ¡ˆ

- åˆ†æï¼š
  - 
- è§£å†³æ–¹æ¡ˆï¼š
  - 
- ç»“æœï¼šæˆåŠŸè§£å†³é—®é¢˜



## 06.è¿›ä¸€æ­¥æ€è€ƒ

### 6.1 OkHttpåŸç†

- 

### 6.2 æ¨èæ–¹æ¡ˆ





## 07.æ ¹æœ¬åŸå› å’Œä¿®å¤

### 7.1 æœ€ç»ˆå®šä½

- 


### 7.2 ä¿®å¤æ–¹æ¡ˆ



## 08.ç»éªŒæ€»ç»“

### 8.1 æŠ€æœ¯åŸç†

### 8.2 é¢„é˜²æªæ–½

### 8.3 å¸è½½è§„èŒƒ

### 8.4 è°ƒè¯•æŠ€å·§